# 总结 - 代码同步和构建触发

**时间**: 2026-01-19  
**状态**: ✅ Job 配置已创建，可以触发构建

## ✅ 已完成

1. **Job 配置已创建**: `/var/jenkins_home/jobs/suntaya-server-blog/config.xml`
2. **配置内容验证**:
   - Repository URL: `git@github.com:slk1061569042-lab/suntaya_server_blog.git` ✅
   - Branch: `*/main` ✅
   - Credential: `github-ssh-key` ✅
   - Script Path: `Jenkinsfile` ✅
3. **权限已修复**: 文件所有者已设置为 `jenkins:jenkins`

## 🔍 关于代码同步

### 重要说明

**Jenkins 不会预先同步代码到工作区**。代码同步发生在构建时：

1. **触发构建** → Jenkins 开始执行 Pipeline
2. **Checkout 阶段** → Jenkins 从 GitHub 拉取代码到工作区
3. **工作区创建** → `/var/jenkins_home/jobs/suntaya-server-blog/workspace/`

因此，**只有在构建时才能看到代码是否同步成功**。

### 如何验证代码同步

构建开始后，在构建日志中应该看到：

```
[Pipeline] checkout
Cloning repository git@github.com:slk1061569042-lab/suntaya_server_blog.git
Checking out branch main
Commit: xxxxx (最新的提交哈希)
```

如果看到这些内容，说明代码已成功从 GitHub 同步。

---

## 🧪 触发构建

### 方法 1: 通过 Web UI（推荐）

1. **访问 Jenkins**: http://115.190.54.220:14808
2. **刷新页面**: 按 `F5` 刷新，应该能看到 `suntaya-server-blog` Job
3. **进入 Job**: 点击 `suntaya-server-blog`
4. **触发构建**: 点击左侧菜单的 **Build Now**（立即构建）

### 方法 2: 等待自动触发

如果配置了 GitHub Webhook，推送代码到 GitHub 时会自动触发构建。

---

## 📋 构建后的验证步骤

### 步骤 1: 观察构建过程

构建开始后，点击构建号查看 **Console Output**，应该看到：

```
[Pipeline] stage
[Pipeline] { (Checkout)
[Pipeline] checkout
Cloning repository git@github.com:slk1061569042-lab/suntaya_server_blog.git
Checking out branch main
```

### 步骤 2: 验证代码同步

如果看到以下内容，说明代码已成功同步：

- ✅ `Cloning repository` - 正在克隆仓库
- ✅ `Checking out branch main` - 正在检出 main 分支
- ✅ `Commit: xxxxx` - 显示提交哈希

### 步骤 3: 验证工作区（可选）

构建开始后，可以检查工作区：

```bash
ssh root@115.190.54.220 "docker exec jenkins_hwfa-jenkins_hWFA-1 bash -c 'ls -la /var/jenkins_home/jobs/suntaya-server-blog/workspace/ 2>&1 | head -20'"
```

应该能看到：
- `Jenkinsfile`
- `package.json`
- `next.config.ts`
- 其他项目文件

### 步骤 4: 验证构建流程

应该看到以下阶段：

1. ✅ **Checkout**: 代码检出
2. ✅ **Install Dependencies**: 安装依赖
3. ✅ **Lint**: 代码检查（如果有）
4. ✅ **Build Next.js**: 构建项目
5. ✅ **Export static site**: 静态导出
6. ✅ **Deploy**: 部署到服务器

---

## 🔍 如果构建失败

### 查看构建日志

1. 进入失败的构建
2. 点击 **Console Output**
3. 查找错误信息
4. **告诉我具体的错误**，我会帮你解决

### 常见问题

1. **代码拉取失败**:
   - 错误: `Permission denied` 或 `Host key verification failed`
   - 解决: 检查 Credential、SSH Config 和 Known Hosts

2. **插件错误**:
   - 错误: `Invalid agent type "docker"`
   - 解决: 检查插件是否已正确加载

3. **构建错误**:
   - 错误: `npm install failed` 或 `npm run build failed`
   - 解决: 查看具体的 npm 错误信息

---

## 📊 总结

- ✅ **Job 配置已创建**: 可以在 Jenkins Web UI 中看到
- ✅ **配置内容正确**: Repository URL、Branch、Credential 都已配置
- ⏳ **代码同步**: 需要在构建时验证（构建时会自动从 GitHub 拉取）
- 🧪 **触发构建**: 在 Web UI 中点击 **Build Now**

**提示**: 现在可以在 Jenkins Web UI 中触发构建了。构建开始后，代码会自动从 GitHub 同步到 Jenkins 工作区。如果构建失败，告诉我具体的错误信息，我会帮你解决。
