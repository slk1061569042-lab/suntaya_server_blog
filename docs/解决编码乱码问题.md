# è§£å†³ç¼–ç ä¹±ç é—®é¢˜

**æ—¶é—´**: 2026-01-20  
**é—®é¢˜**: Git æäº¤ä¿¡æ¯ä¹±ç ã€Jenkins éƒ¨ç½²æ—¶ä¹±ç 

## ğŸ” é—®é¢˜åˆ†æ

### å½“å‰é—®é¢˜

1. **Git æäº¤ä¿¡æ¯ä¹±ç **ï¼š
   ```
   fix: æ·‡?Next.js standalone é–®ã„§è®²éµæ’³å¯˜é–«æ˜ç·«
   ```
   åº”è¯¥æ˜¯ï¼š
   ```
   fix: ä¿®å¤ Next.js standalone éƒ¨ç½²æ‰“åŒ…é€»è¾‘
   ```

2. **Jenkins æ§åˆ¶å°è¾“å‡ºä¹±ç **ï¼š
   - ä¸­æ–‡æ˜¾ç¤ºä¸ºä¹±ç 
   - å¯èƒ½æ˜¯ç¼–ç é…ç½®é—®é¢˜

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: é…ç½® Git ä½¿ç”¨ UTF-8ï¼ˆæ¨èï¼‰

#### Windows PowerShell é…ç½®

**æ­¥éª¤ 1: è®¾ç½® Git ç¼–ç **
```powershell
# è®¾ç½® Git æäº¤ä¿¡æ¯ä½¿ç”¨ UTF-8
git config --global i18n.commitencoding utf-8

# è®¾ç½® Git æ—¥å¿—è¾“å‡ºä½¿ç”¨ UTF-8
git config --global i18n.logoutputencoding utf-8

# è®¾ç½® Git æ–‡ä»¶è·¯å¾„ä½¿ç”¨ UTF-8
git config --global core.quotepath false

# éªŒè¯é…ç½®
git config --global --list | Select-String encoding
```

**æ­¥éª¤ 2: è®¾ç½® PowerShell ç¼–ç **
```powershell
# è®¾ç½® PowerShell è¾“å‡ºç¼–ç ä¸º UTF-8
[Console]::OutputEncoding = [System.Text.Encoding]::UTF-8
$PSDefaultParameterValues['*:Encoding'] = 'utf8'

# æ°¸ä¹…è®¾ç½®ï¼ˆæ·»åŠ åˆ° PowerShell é…ç½®æ–‡ä»¶ï¼‰
# æŸ¥çœ‹é…ç½®æ–‡ä»¶è·¯å¾„
$PROFILE

# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ï¼š
[Console]::OutputEncoding = [System.Text.Encoding]::UTF-8
$PSDefaultParameterValues['*:Encoding'] = 'utf8'
```

**æ­¥éª¤ 3: è®¾ç½®ç¯å¢ƒå˜é‡**
```powershell
# è®¾ç½®ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
[System.Environment]::SetEnvironmentVariable('LANG', 'zh_CN.UTF-8', 'User')
[System.Environment]::SetEnvironmentVariable('LC_ALL', 'zh_CN.UTF-8', 'User')

# æˆ–è€…ä½¿ç”¨ chcp å‘½ä»¤ï¼ˆä¸´æ—¶ï¼‰
chcp 65001
```

---

### æ–¹æ¡ˆ 2: é…ç½® Jenkins ä½¿ç”¨ UTF-8

#### Jenkins ç³»ç»Ÿé…ç½®

**æ­¥éª¤ 1: è®¾ç½® Jenkins ç³»ç»Ÿå±æ€§**

1. **æ‰“å¼€ Jenkins**ï¼šManage Jenkins â†’ Configure System
2. **æ‰¾åˆ° "Global properties"** éƒ¨åˆ†
3. **å‹¾é€‰ "Environment variables"**
4. **æ·»åŠ ç¯å¢ƒå˜é‡**ï¼š
   ```
   Name: LANG
   Value: zh_CN.UTF-8
   
   Name: LC_ALL
   Value: zh_CN.UTF-8
   
   Name: JAVA_TOOL_OPTIONS
   Value: -Dfile.encoding=UTF-8 -Duser.language=zh -Duser.country=CN
   ```

**æ­¥éª¤ 2: è®¾ç½® Jenkins å¯åŠ¨å‚æ•°**

å¦‚æœ Jenkins è¿è¡Œåœ¨ Docker ä¸­ï¼Œéœ€è¦åœ¨å¯åŠ¨æ—¶è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
# åœ¨ Jenkins å®¹å™¨å¯åŠ¨æ—¶æ·»åŠ 
docker run -e LANG=zh_CN.UTF-8 -e LC_ALL=zh_CN.UTF-8 ...
```

æˆ–è€…åœ¨ `docker-compose.yml` ä¸­ï¼š
```yaml
services:
  jenkins:
    environment:
      - LANG=zh_CN.UTF-8
      - LC_ALL=zh_CN.UTF-8
      - JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF-8
```

**æ­¥éª¤ 3: åœ¨ Jenkinsfile ä¸­è®¾ç½®ç¼–ç **

åœ¨ Jenkinsfile çš„å¼€å¤´æ·»åŠ ï¼š
```groovy
pipeline {
    agent {
        docker {
            image 'node:20-alpine'
            args '-u root:root'
        }
    }

    environment {
        // è®¾ç½®ç¼–ç 
        LANG = 'zh_CN.UTF-8'
        LC_ALL = 'zh_CN.UTF-8'
        // ... å…¶ä»–ç¯å¢ƒå˜é‡
    }
    
    // ... å…¶ä»–é…ç½®
}
```

---

### æ–¹æ¡ˆ 3: ä¿®å¤å·²æäº¤çš„ä¹±ç ä¿¡æ¯

#### ä½¿ç”¨ git commit --amendï¼ˆä»…é™æœ€åä¸€æ¬¡æäº¤ï¼‰

```powershell
# 1. è®¾ç½®æ­£ç¡®çš„ç¼–ç 
[Console]::OutputEncoding = [System.Text.Encoding]::UTF-8
chcp 65001

# 2. ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤ä¿¡æ¯
git commit --amend -m "fix: ä¿®å¤ Next.js standalone éƒ¨ç½²æ‰“åŒ…é€»è¾‘"

# 3. å¼ºåˆ¶æ¨é€ï¼ˆå¦‚æœå·²ç»æ¨é€ï¼‰
git push --force-with-lease origin main
```

#### ä½¿ç”¨ git rebaseï¼ˆä¿®æ”¹å¤šä¸ªæäº¤ï¼‰

```powershell
# 1. è®¾ç½®ç¼–ç 
[Console]::OutputEncoding = [System.Text.Encoding]::UTF-8
chcp 65001

# 2. äº¤äº’å¼ rebaseï¼ˆä¿®æ”¹æœ€è¿‘ 3 æ¬¡æäº¤ï¼‰
git rebase -i HEAD~3

# 3. åœ¨ç¼–è¾‘å™¨ä¸­ï¼Œå°†è¦ä¿®æ”¹çš„æäº¤å‰çš„ 'pick' æ”¹ä¸º 'reword'
# 4. ä¿å­˜å¹¶é€€å‡ºï¼ŒGit ä¼šé€ä¸ªæç¤ºä¿®æ”¹æäº¤ä¿¡æ¯
# 5. è¾“å…¥æ­£ç¡®çš„ä¸­æ–‡æäº¤ä¿¡æ¯
# 6. å¼ºåˆ¶æ¨é€
git push --force-with-lease origin main
```

---

## ğŸ”§ å¿«é€Ÿä¿®å¤è„šæœ¬

### PowerShell è„šæœ¬

åˆ›å»º `scripts/fix-encoding.ps1`ï¼š

```powershell
# è®¾ç½® PowerShell ç¼–ç 
[Console]::OutputEncoding = [System.Text.Encoding]::UTF-8
$PSDefaultParameterValues['*:Encoding'] = 'utf8'
chcp 65001 | Out-Null

# é…ç½® Git ç¼–ç 
Write-Host "é…ç½® Git ç¼–ç ..." -ForegroundColor Green
git config --global i18n.commitencoding utf-8
git config --global i18n.logoutputencoding utf-8
git config --global core.quotepath false

# éªŒè¯é…ç½®
Write-Host "`nGit ç¼–ç é…ç½®ï¼š" -ForegroundColor Yellow
git config --global --list | Select-String encoding

Write-Host "`nå½“å‰ PowerShell ç¼–ç ï¼š" -ForegroundColor Yellow
[Console]::OutputEncoding

Write-Host "`nâœ… ç¼–ç é…ç½®å®Œæˆï¼" -ForegroundColor Green
Write-Host "æç¤ºï¼šé‡æ–°æ‰“å¼€ PowerShell çª—å£ä»¥åº”ç”¨æ‰€æœ‰è®¾ç½®" -ForegroundColor Cyan
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
```powershell
.\scripts\fix-encoding.ps1
```

---

## ğŸ“‹ Jenkinsfile ç¼–ç é…ç½®

### åœ¨ Jenkinsfile ä¸­æ·»åŠ ç¼–ç è®¾ç½®

```groovy
pipeline {
    agent {
        docker {
            image 'node:20-alpine'
            args '-u root:root'
        }
    }

    environment {
        // ç¼–ç è®¾ç½®
        LANG = 'zh_CN.UTF-8'
        LC_ALL = 'zh_CN.UTF-8'
        PYTHONIOENCODING = 'utf-8'
        
        // éƒ¨ç½²æœåŠ¡å™¨ä¿¡æ¯
        DEPLOY_HOST = '115.190.54.220'
        DEPLOY_PORT = '22'
        DEPLOY_USER = 'root'
        DEPLOY_DIR  = '/www/wwwroot/next.sunyas.com'
        APP_PORT    = '3000'

        CI = 'true'
        npm_config_ignore_scripts = 'true'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 20, unit: 'MINUTES')
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    // è®¾ç½® Shell ç¼–ç 
                    sh '''
                        export LANG=zh_CN.UTF-8
                        export LC_ALL=zh_CN.UTF-8
                        echo "æ­£åœ¨æ£€å‡ºä»£ç ..."
                    '''
                }
                checkout scm
                sh 'pwd && ls -la'
            }
        }
        
        // ... å…¶ä»– stages
    }
}
```

---

## ğŸ¯ éªŒè¯ä¿®å¤

### éªŒè¯ Git ç¼–ç 

```powershell
# 1. è®¾ç½®ç¼–ç 
[Console]::OutputEncoding = [System.Text.Encoding]::UTF-8
chcp 65001

# 2. æµ‹è¯•æäº¤
git commit --allow-empty -m "æµ‹è¯•: ä¸­æ–‡ç¼–ç æµ‹è¯•"

# 3. æŸ¥çœ‹æäº¤ä¿¡æ¯
git log -1 --pretty=format:"%s"

# åº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„ä¸­æ–‡ï¼Œè€Œä¸æ˜¯ä¹±ç 
```

### éªŒè¯ Jenkins ç¼–ç 

1. **è§¦å‘ä¸€æ¬¡æ„å»º**
2. **æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º**ï¼šä¸­æ–‡åº”è¯¥æ­£å¸¸æ˜¾ç¤º
3. **æ£€æŸ¥æ—¥å¿—æ–‡ä»¶**ï¼šå¦‚æœæœ‰æ—¥å¿—æ–‡ä»¶ï¼Œæ£€æŸ¥ç¼–ç æ˜¯å¦æ­£ç¡®

---

## ğŸ“ æ€»ç»“

### éœ€è¦é…ç½®çš„åœ°æ–¹

1. **Git é…ç½®**ï¼š
   - `i18n.commitencoding = utf-8`
   - `i18n.logoutputencoding = utf-8`
   - `core.quotepath = false`

2. **PowerShell é…ç½®**ï¼š
   - `[Console]::OutputEncoding = UTF-8`
   - `chcp 65001`ï¼ˆä¸´æ—¶ï¼‰

3. **Jenkins é…ç½®**ï¼š
   - ç¯å¢ƒå˜é‡ï¼š`LANG=zh_CN.UTF-8`
   - ç¯å¢ƒå˜é‡ï¼š`LC_ALL=zh_CN.UTF-8`
   - ç¯å¢ƒå˜é‡ï¼š`JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF-8`

4. **Jenkinsfile é…ç½®**ï¼š
   - åœ¨ `environment` å—ä¸­è®¾ç½®ç¼–ç ç¯å¢ƒå˜é‡
   - åœ¨ `sh` å‘½ä»¤ä¸­è®¾ç½® `export LANG=zh_CN.UTF-8`

### ä¿®å¤å·²æäº¤çš„ä¹±ç 

- **æœ€åä¸€æ¬¡æäº¤**ï¼šä½¿ç”¨ `git commit --amend`
- **å¤šä¸ªæäº¤**ï¼šä½¿ç”¨ `git rebase -i`

---

**æœ€åæ›´æ–°**: 2026-01-20
