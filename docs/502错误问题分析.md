# 502 é”™è¯¯é—®é¢˜åˆ†æ

**æ—¶é—´**: 2026-01-20  
**é—®é¢˜**: æ„å»ºæˆåŠŸä½†ç½‘ç«™æ˜¾ç¤º 502 é”™è¯¯

## ğŸ” é—®é¢˜è¯Šæ–­

### å½“å‰çŠ¶æ€

1. **PM2 çŠ¶æ€**: `errored`ï¼ˆå¯åŠ¨å¤±è´¥ï¼‰
2. **é”™è¯¯æ—¥å¿—**: `Error: ENOENT: no such file or directory, open '/www/wwwroot/next.sunyas.com/.next/routes-manifest.json'`
3. **ç«¯å£ç›‘å¬**: 3000 ç«¯å£æœªç›‘å¬ï¼ˆåº”ç”¨æœªå¯åŠ¨ï¼‰
4. **ç›®å½•ç»“æ„**: `.next` ç›®å½•åªæœ‰ `BUILD_ID` æ–‡ä»¶ï¼Œç¼ºå°‘å…¶ä»–å¿…è¦æ–‡ä»¶

---

## âŒ é—®é¢˜æ ¹æº

### Jenkinsfile æ‰“åŒ…é€»è¾‘é”™è¯¯

**å½“å‰æ‰“åŒ…é€»è¾‘**ï¼ˆç¬¬ 112-164 è¡Œï¼‰ï¼š
```groovy
# å¤åˆ¶ standalone æ–‡ä»¶
cp -r .next/standalone/* deploy-package/

# å¤åˆ¶ .next ç›®å½•
mkdir -p deploy-package/.next
cp -r .next/standalone deploy-package/.next/  # âŒ é”™è¯¯ï¼šè¿™ä¼šæŠŠ standalone ç›®å½•å¤åˆ¶åˆ° .next/standalone
```

**é—®é¢˜**ï¼š
1. `cp -r .next/standalone deploy-package/.next/` ä¼šæŠŠ standalone ç›®å½•å¤åˆ¶åˆ° `.next/standalone`
2. ä½† Next.js éœ€è¦ `.next` ç›®å½•åŒ…å«å®Œæ•´çš„æ„å»ºäº§ç‰©ï¼ŒåŒ…æ‹¬ï¼š
   - `routes-manifest.json`
   - `server.js` éœ€è¦çš„å…¶ä»–æ–‡ä»¶
   - `static` ç›®å½•
   - `BUILD_ID`

**å½“å‰éƒ¨ç½²åçš„ç›®å½•ç»“æ„**ï¼š
```
/www/wwwroot/next.sunyas.com/
â”œâ”€â”€ server.js          âœ… (æ¥è‡ª standalone)
â”œâ”€â”€ package.json       âœ…
â”œâ”€â”€ .next/
â”‚   â”œâ”€â”€ BUILD_ID       âœ…
â”‚   â””â”€â”€ standalone/    âŒ ä¸åº”è¯¥åœ¨è¿™é‡Œ
â””â”€â”€ (ç¼ºå°‘ routes-manifest.json ç­‰æ–‡ä»¶)
```

**æ­£ç¡®çš„ç›®å½•ç»“æ„åº”è¯¥æ˜¯**ï¼š
```
/www/wwwroot/next.sunyas.com/
â”œâ”€â”€ server.js          âœ… (æ¥è‡ª standalone)
â”œâ”€â”€ package.json       âœ…
â”œâ”€â”€ .next/
â”‚   â”œâ”€â”€ BUILD_ID       âœ…
â”‚   â”œâ”€â”€ static/        âœ… (é™æ€èµ„æº)
â”‚   â”œâ”€â”€ routes-manifest.json  âœ… (è·¯ç”±æ¸…å•)
â”‚   â””â”€â”€ (å…¶ä»–å¿…è¦çš„æ„å»ºæ–‡ä»¶)
```

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### Next.js Standalone æ¨¡å¼éƒ¨ç½²è¦æ±‚

æ ¹æ® Next.js æ–‡æ¡£ï¼Œstandalone æ¨¡å¼éƒ¨ç½²éœ€è¦ï¼š

1. **Standalone ç›®å½•å†…å®¹** â†’ éƒ¨ç½²ç›®å½•æ ¹ç›®å½•
   - `server.js`
   - `node_modules/`ï¼ˆæœ€å°åŒ–ä¾èµ–ï¼‰
   - å…¶ä»– standalone æ–‡ä»¶

2. **`.next/static`** â†’ éƒ¨ç½²ç›®å½•çš„ `.next/static`
   - é™æ€èµ„æºæ–‡ä»¶

3. **`.next/BUILD_ID`** â†’ éƒ¨ç½²ç›®å½•çš„ `.next/BUILD_ID`
   - æ„å»º ID

4. **`.next` ç›®å½•ä¸­çš„å…¶ä»–å¿…è¦æ–‡ä»¶** â†’ éƒ¨ç½²ç›®å½•çš„ `.next/`
   - `routes-manifest.json`
   - `prerender-manifest.json`
   - å…¶ä»–æ„å»ºå…ƒæ•°æ®

---

## ğŸ“‹ ä¿®å¤æ­¥éª¤

### æ–¹æ¡ˆ 1: ä¿®å¤ Jenkinsfile æ‰“åŒ…é€»è¾‘ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `Package for deployment` é˜¶æ®µï¼š

```groovy
stage('Package for deployment') {
    steps {
        echo 'æ­£åœ¨æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶...'
        sh '''
          set -e
          
          # æ£€æŸ¥æ„å»ºè¾“å‡º
          if [ ! -d ".next" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° .next ç›®å½•ï¼Œæ„å»ºå¤±è´¥"
            exit 1
          fi
          
          # æ£€æŸ¥ standalone è¾“å‡º
          if [ ! -d ".next/standalone" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° .next/standalone ç›®å½•ï¼Œè¯·ç¡®ä¿ next.config.ts ä¸­é…ç½®äº† output: 'standalone'"
            exit 1
          fi
          
          echo "===> æ„å»ºè¾“å‡ºç›®å½•ï¼š"
          ls -la .next/standalone
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          echo "===> å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
          mkdir -p deploy-package
          
          # 1. å¤åˆ¶ standalone ç›®å½•å†…å®¹åˆ°éƒ¨ç½²åŒ…æ ¹ç›®å½•
          cp -r .next/standalone/* deploy-package/
          
          # 2. åˆ›å»º .next ç›®å½•å¹¶å¤åˆ¶å¿…è¦çš„æ–‡ä»¶
          mkdir -p deploy-package/.next
          
          # å¤åˆ¶ static ç›®å½•ï¼ˆå¿…éœ€ï¼‰
          if [ -d ".next/static" ]; then
            cp -r .next/static deploy-package/.next/
          fi
          
          # å¤åˆ¶ BUILD_IDï¼ˆå¿…éœ€ï¼‰
          if [ -f ".next/BUILD_ID" ]; then
            cp .next/BUILD_ID deploy-package/.next/
          fi
          
          # å¤åˆ¶ routes-manifest.jsonï¼ˆå¿…éœ€ï¼‰
          if [ -f ".next/routes-manifest.json" ]; then
            cp .next/routes-manifest.json deploy-package/.next/
          fi
          
          # å¤åˆ¶ prerender-manifest.jsonï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f ".next/prerender-manifest.json" ]; then
            cp .next/prerender-manifest.json deploy-package/.next/
          fi
          
          # å¤åˆ¶ images-manifest.jsonï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f ".next/images-manifest.json" ]; then
            cp .next/images-manifest.json deploy-package/.next/
          fi
          
          # å¤åˆ¶ public ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "public" ]; then
            cp -r public deploy-package/
          fi
          
          # å¤åˆ¶ package.jsonï¼ˆç”¨äº PM2 å¯åŠ¨ï¼‰
          cp package.json deploy-package/
          
          echo "===> éƒ¨ç½²åŒ…å†…å®¹ï¼š"
          ls -la deploy-package
          echo "===> .next ç›®å½•å†…å®¹ï¼š"
          ls -la deploy-package/.next
        '''
    }
}
```

---

### æ–¹æ¡ˆ 2: å¤åˆ¶æ•´ä¸ª .next ç›®å½•ï¼ˆæ›´ç®€å•ï¼Œä½†åŒ…æ›´å¤§ï¼‰

å¦‚æœæ–¹æ¡ˆ 1 å¤ªå¤æ‚ï¼Œå¯ä»¥å¤åˆ¶æ•´ä¸ª `.next` ç›®å½•ï¼š

```groovy
# å¤åˆ¶æ•´ä¸ª .next ç›®å½•ï¼ˆåŒ…å«æ‰€æœ‰å¿…è¦æ–‡ä»¶ï¼‰
cp -r .next deploy-package/
```

**æ³¨æ„**ï¼šè¿™ä¼šåŒ…å«ä¸€äº›ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œä½†èƒ½ç¡®ä¿æ‰€æœ‰å¿…éœ€æ–‡ä»¶éƒ½åœ¨ã€‚

---

## ğŸ¯ æ¨èä¿®å¤

ä½¿ç”¨æ–¹æ¡ˆ 1ï¼Œä½†æ›´å®‰å…¨çš„æ–¹å¼æ˜¯å¤åˆ¶æ•´ä¸ª `.next` ç›®å½•ï¼Œç„¶ååªä¿ç•™ standalone çš„æ ¹æ–‡ä»¶ï¼š

```groovy
# 1. å¤åˆ¶ standalone å†…å®¹åˆ°æ ¹ç›®å½•
cp -r .next/standalone/* deploy-package/

# 2. å¤åˆ¶æ•´ä¸ª .next ç›®å½•ï¼ˆåŒ…å«æ‰€æœ‰å¿…è¦æ–‡ä»¶ï¼‰
cp -r .next deploy-package/
# ä½†éœ€è¦åˆ é™¤ deploy-package/.next/standaloneï¼ˆå› ä¸ºå·²ç»åœ¨æ ¹ç›®å½•äº†ï¼‰
rm -rf deploy-package/.next/standalone
```

---

## ğŸ“Š éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œæ£€æŸ¥éƒ¨ç½²ç›®å½•ï¼š

```bash
# æ£€æŸ¥ .next ç›®å½•ç»“æ„
ls -la /www/wwwroot/next.sunyas.com/.next/

# åº”è¯¥çœ‹åˆ°ï¼š
# - BUILD_ID
# - static/
# - routes-manifest.json
# - (å…¶ä»–å¿…è¦æ–‡ä»¶)

# æ£€æŸ¥åº”ç”¨å¯åŠ¨
pm2 list
# åº”è¯¥æ˜¾ç¤ºï¼šonline

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 3000
# åº”è¯¥æ˜¾ç¤ºï¼šLISTEN
```

---

**æœ€åæ›´æ–°**: 2026-01-20
