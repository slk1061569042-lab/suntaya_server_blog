# Docker æƒé™é—®é¢˜è¯¦ç»†è¯´æ˜

**æ—¶é—´**: 2026-01-19  
**é—®é¢˜**: Jenkins æ„å»ºå¤±è´¥ï¼ŒDocker æƒé™è¢«æ‹’ç»

## ğŸ” é—®é¢˜è¯¦è§£

### 1. è¿™ä¸ªæƒé™æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**é—®é¢˜**: Jenkins å®¹å™¨å†…çš„ `jenkins` ç”¨æˆ·æ— æ³•è®¿é—® Docker socket (`/var/run/docker.sock`)ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œ Docker å‘½ä»¤ã€‚

**é”™è¯¯ä¿¡æ¯**:
```
permission denied while trying to connect to the docker API at unix:///var/run/docker.sock
```

### 2. è¿™éœ€è¦ä»€ä¹ˆç‰¹æ®Šæƒé™å—ï¼Ÿ

**éœ€è¦**: è®¿é—® Docker socket çš„æƒé™ã€‚

**Docker socket æƒé™è¯´æ˜**:
- Docker socket (`/var/run/docker.sock`) æ˜¯ä¸€ä¸ª Unix socket æ–‡ä»¶
- é»˜è®¤æƒé™é€šå¸¸æ˜¯ `srw-rw----` (660)
- æ‰€æœ‰è€…: `root`
- æ‰€å±ç»„: `docker` (GID 988)
- **åªæœ‰ root ç”¨æˆ·å’Œ docker ç»„çš„æˆå‘˜å¯ä»¥è®¿é—®**

### 3. ä¹‹å‰çš„æƒé™æ˜¯ä»€ä¹ˆï¼Ÿ

**å®¿ä¸»æœºä¸Šçš„ Docker socket**:
```
srw-rw---- 1 root docker (GID 988)
```

**Jenkins å®¹å™¨å†…çš„æƒ…å†µ**:
- Docker socket å·²æŒ‚è½½: `/var/run/docker.sock:/var/run/docker.sock` âœ…
- Docker socket æƒé™: `srw-rw---- 1 root 988` âœ…
- **é—®é¢˜**: Jenkins å®¹å™¨å†…æ²¡æœ‰ GID 988 çš„ç»„
- **é—®é¢˜**: `jenkins` ç”¨æˆ·ä¸åœ¨ docker ç»„ä¸­
- **ç»“æœ**: `jenkins` ç”¨æˆ·æ— æ³•è®¿é—® Docker socket

### 4. æˆ‘æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

æˆ‘é‡‡ç”¨äº†**ä¸¤ç§æ–¹æ¡ˆ**ï¼ˆæ··åˆä½¿ç”¨ï¼‰ï¼š

#### æ–¹æ¡ˆ 1: åˆ›å»º docker ç»„å¹¶æ·»åŠ ç”¨æˆ·ï¼ˆæ¨èï¼‰

```bash
# 1. åœ¨å®¹å™¨å†…åˆ›å»º docker ç»„ï¼ˆGID 988ï¼Œä¸å®¿ä¸»æœºä¸€è‡´ï¼‰
docker exec -u root jenkins_hwfa-jenkins_hWFA-1 groupadd -g 988 docker

# 2. å°† jenkins ç”¨æˆ·æ·»åŠ åˆ° docker ç»„
docker exec -u root jenkins_hwfa-jenkins_hWFA-1 usermod -aG docker jenkins

# 3. éªŒè¯
docker exec jenkins_hwfa-jenkins_hWFA-1 id jenkins
# åº”è¯¥çœ‹åˆ°: groups=1000(jenkins),988(docker)
```

#### æ–¹æ¡ˆ 2: ä¿®æ”¹ Docker socket æƒé™ï¼ˆä¸´æ—¶ï¼Œä¸æ¨èï¼‰

```bash
# ä¿®æ”¹æƒé™ä¸º 666ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è¯»å†™ï¼‰
docker exec -u root jenkins_hwfa-jenkins_hWFA-1 chmod 666 /var/run/docker.sock
```

**ä¸ºä»€ä¹ˆä¸¤ç§éƒ½ç”¨ï¼Ÿ**
- æ–¹æ¡ˆ 1 æ˜¯æ­£ç¡®çš„æ–¹å¼ï¼Œä½†éœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•æˆ–ä½¿ç”¨ `newgrp` æ‰èƒ½ç”Ÿæ•ˆ
- æ–¹æ¡ˆ 2 æ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œç«‹å³ç”Ÿæ•ˆï¼Œä½†å®‰å…¨æ€§è¾ƒä½

### 5. è¿™ä¹ˆåšæ¨èå—ï¼Ÿ

#### âœ… æ¨èçš„åšæ³•

**æ–¹æ¡ˆ 1: ä½¿ç”¨ç»„çš„æ–¹å¼ï¼ˆæ¨èï¼‰**

ä¼˜ç‚¹ï¼š
- âœ… ç¬¦åˆ Linux æƒé™æ¨¡å‹
- âœ… å®‰å…¨æ€§é«˜ï¼ˆåªæœ‰ç‰¹å®šç»„çš„ç”¨æˆ·å¯ä»¥è®¿é—®ï¼‰
- âœ… ç¬¦åˆ Docker æœ€ä½³å®è·µ

ç¼ºç‚¹ï¼š
- âš ï¸ å®¹å™¨é‡å¯åéœ€è¦é‡æ–°é…ç½®ï¼ˆé™¤éæŒä¹…åŒ–ï¼‰
- âš ï¸ éœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•æˆ–ä½¿ç”¨ `newgrp` æ‰èƒ½ç”Ÿæ•ˆ

**æŒä¹…åŒ–æ–¹æ¡ˆ**:
åœ¨å®¹å™¨å¯åŠ¨æ—¶æ·»åŠ  `--group-add 988` å‚æ•°ï¼š

```bash
docker run ... --group-add 988 ...
```

æˆ–åœ¨ Docker Compose ä¸­ï¼š
```yaml
services:
  jenkins:
    group_add:
      - "988"
```

#### âŒ ä¸æ¨èçš„åšæ³•

**æ–¹æ¡ˆ 2: ä¿®æ”¹ socket æƒé™ä¸º 666**

ç¼ºç‚¹ï¼š
- âŒ **å®‰å…¨æ€§ä½**ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—® Docker socket
- âŒ **ä¸ç¬¦åˆæœ€ä½³å®è·µ**ï¼šè¿åäº†æœ€å°æƒé™åŸåˆ™
- âŒ **å®¹å™¨é‡å¯åå¯èƒ½å¤±æ•ˆ**ï¼šå¦‚æœæŒ‚è½½çš„æ˜¯å®¿ä¸»æœº socketï¼Œæƒé™å¯èƒ½è¢«é‡ç½®

---

## ğŸ“‹ æœ€ä½³å®è·µå»ºè®®

### æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨ç»„ + æŒä¹…åŒ–é…ç½®

1. **åœ¨å®¹å™¨å¯åŠ¨æ—¶æ·»åŠ ç»„**:
   - ä½¿ç”¨ `--group-add 988` å‚æ•°
   - æˆ–åœ¨ Docker Compose ä¸­é…ç½® `group_add`

2. **ç¡®ä¿ç”¨æˆ·åœ¨è¯¥ç»„ä¸­**:
   - åœ¨å®¹å™¨å¯åŠ¨è„šæœ¬ä¸­æ·»åŠ ç”¨æˆ·åˆ°ç»„
   - æˆ–ä½¿ç”¨è‡ªå®šä¹‰é•œåƒï¼Œåœ¨æ„å»ºæ—¶é…ç½®

3. **éªŒè¯æƒé™**:
   ```bash
   docker exec jenkins_hwfa-jenkins_hWFA-1 id jenkins
   # åº”è¯¥çœ‹åˆ° docker(988) åœ¨ groups ä¸­
   ```

### å½“å‰çŠ¶æ€

**å·²å®Œæˆçš„ä¿®å¤**:
- âœ… åˆ›å»ºäº† docker ç»„ï¼ˆGID 988ï¼‰
- âœ… å°† jenkins ç”¨æˆ·æ·»åŠ åˆ° docker ç»„
- âš ï¸ ä¸´æ—¶ä¿®æ”¹äº† socket æƒé™ä¸º 666ï¼ˆä¸æ¨èï¼Œä½†å·²ç”Ÿæ•ˆï¼‰

**å»ºè®®çš„æ”¹è¿›**:
1. æ¢å¤ socket æƒé™ä¸ºé»˜è®¤å€¼ï¼ˆ660ï¼‰
2. åœ¨å®¹å™¨å¯åŠ¨é…ç½®ä¸­æ·»åŠ  `--group-add 988`
3. éªŒè¯ç»„æƒé™æ˜¯å¦è¶³å¤Ÿ

---

## ğŸ”§ å¦‚ä½•æ”¹è¿›å½“å‰é…ç½®

### æ­¥éª¤ 1: æ¢å¤ socket æƒé™

```bash
# æ¢å¤ä¸ºé»˜è®¤æƒé™ï¼ˆ660ï¼‰
docker exec -u root jenkins_hwfa-jenkins_hWFA-1 chmod 660 /var/run/docker.sock
docker exec -u root jenkins_hwfa-jenkins_hWFA-1 chown root:988 /var/run/docker.sock
```

### æ­¥éª¤ 2: éªŒè¯ç»„æƒé™æ˜¯å¦è¶³å¤Ÿ

```bash
# æµ‹è¯•ï¼ˆåº”è¯¥èƒ½æ­£å¸¸å·¥ä½œï¼Œå› ä¸º jenkins åœ¨ docker ç»„ä¸­ï¼‰
docker exec -u jenkins jenkins_hwfa-jenkins_hWFA-1 docker ps
```

### æ­¥éª¤ 3: æŒä¹…åŒ–é…ç½®

ä¿®æ”¹å®¹å™¨å¯åŠ¨é…ç½®ï¼Œæ·»åŠ  `--group-add 988`ï¼Œè¿™æ ·å®¹å™¨é‡å¯åé…ç½®ä»ç„¶æœ‰æ•ˆã€‚

---

## ğŸ“Š æ€»ç»“

| æ–¹æ¡ˆ | å®‰å…¨æ€§ | æŒä¹…æ€§ | æ¨èåº¦ |
|------|--------|--------|--------|
| ä½¿ç”¨ç»„ï¼ˆGID 988ï¼‰ | âœ… é«˜ | âš ï¸ éœ€è¦é…ç½® | âœ…âœ…âœ… æ¨è |
| ä¿®æ”¹ socket æƒé™ä¸º 666 | âŒ ä½ | âš ï¸ å¯èƒ½å¤±æ•ˆ | âŒ ä¸æ¨è |
| å½“å‰æ··åˆæ–¹æ¡ˆ | âš ï¸ ä¸­ç­‰ | âš ï¸ éœ€è¦é…ç½® | âš ï¸ ä¸´æ—¶å¯ç”¨ |

**å»ºè®®**: ä½¿ç”¨ç»„çš„æ–¹å¼ï¼Œå¹¶åœ¨å®¹å™¨å¯åŠ¨é…ç½®ä¸­æŒä¹…åŒ–ï¼Œé¿å…ä½¿ç”¨ 666 æƒé™ã€‚
