# è‡ªåŠ¨éƒ¨ç½²æµç¨‹çŠ¶æ€å›¾

**æ—¶é—´**: 2026-01-19  
**é¡¹ç›®**: suntaya_server_blog

## ğŸ”„ å®Œæ•´æµç¨‹çŠ¶æ€å›¾

```mermaid
flowchart TD
    Start([å¼€å§‹]) --> Local[æœ¬åœ°å¼€å‘ç¯å¢ƒ]
    
    Local -->|1. git push| GitHub[GitHub ä»“åº“]
    
    GitHub -->|2. Webhook è§¦å‘| Jenkins[Jenkins æœåŠ¡å™¨]
    GitHub -->|2. SSH æ‹‰å–ä»£ç | Jenkins
    
    Jenkins -->|3. éªŒè¯é…ç½®| Check1{Repository URL<br/>âœ… å·²éªŒè¯}
    Check1 -->|é€šè¿‡| Check2{Credential<br/>âœ… å·²éªŒè¯}
    Check2 -->|é€šè¿‡| Check3{SSH Config<br/>âœ… å·²é…ç½®}
    Check3 -->|é€šè¿‡| Check4{Known Hosts<br/>âœ… å·²æ·»åŠ }
    Check4 -->|é€šè¿‡| Check5{Docker Pipeline æ’ä»¶<br/>âš ï¸ å¾…éªŒè¯}
    
    Check5 -->|é€šè¿‡| Build[æ„å»ºé˜¶æ®µ]
    Check5 -->|å¤±è´¥| Error1[âŒ æ’ä»¶ä¾èµ–é”™è¯¯]
    
    Build --> Stage1[Stage 1: Checkout<br/>ä»£ç æ£€å‡º]
    Stage1 -->|âœ… é…ç½®æ­£ç¡®| Stage2[Stage 2: Install<br/>å®‰è£…ä¾èµ–]
    Stage2 -->|âœ… é…ç½®æ­£ç¡®| Stage3[Stage 3: Lint<br/>ä»£ç æ£€æŸ¥]
    Stage3 -->|âœ… é…ç½®æ­£ç¡®| Stage4[Stage 4: Build<br/>æ„å»º Next.js]
    Stage4 -->|âœ… é…ç½®æ­£ç¡®| Stage5[Stage 5: Export<br/>é™æ€å¯¼å‡º]
    Stage5 -->|âœ… é…ç½®æ­£ç¡®| Stage6[Stage 6: Deploy<br/>SSH éƒ¨ç½²]
    
    Stage6 -->|âœ… é…ç½®æ­£ç¡®| Deploy[éƒ¨ç½²ç›®å½•<br/>/www/wwwroot/next.sunyas.com]
    
    Deploy --> Success([âœ… éƒ¨ç½²æˆåŠŸ])
    Error1 --> Fail([âŒ éƒ¨ç½²å¤±è´¥])
    
    style Start fill:#e1f5ff
    style GitHub fill:#fff4e1
    style Jenkins fill:#ffe1f5
    style Check1 fill:#90ee90
    style Check2 fill:#90ee90
    style Check3 fill:#90ee90
    style Check4 fill:#90ee90
    style Check5 fill:#ffd700
    style Stage1 fill:#e1ffe1
    style Stage2 fill:#e1ffe1
    style Stage3 fill:#e1ffe1
    style Stage4 fill:#e1ffe1
    style Stage5 fill:#e1ffe1
    style Stage6 fill:#e1ffe1
    style Deploy fill:#ffe1e1
    style Success fill:#90ee90
    style Fail fill:#ff6b6b
    style Error1 fill:#ff6b6b
```

## ğŸ“Š ç»„ä»¶è¿æ¥çŠ¶æ€è¡¨

### è¿æ¥ 1: æœ¬åœ° â†’ GitHub

| é¡¹ç›® | çŠ¶æ€ | éªŒè¯æ–¹å¼ |
|------|------|----------|
| SSH è®¤è¯ | âœ… å·²éªŒè¯ | `ssh -T git@github.com-new` æˆåŠŸ |
| å…¬é’¥é…ç½® | âœ… å·²éªŒè¯ | GitHub Settings â†’ SSH Keys ä¸­å¯è§ |
| ä»“åº“è®¿é—® | âœ… å·²éªŒè¯ | `git push` æˆåŠŸ |

### è¿æ¥ 2: GitHub â†’ Jenkins

| é¡¹ç›® | çŠ¶æ€ | éªŒè¯æ–¹å¼ |
|------|------|----------|
| Webhook é…ç½® | âœ… å·²éªŒè¯ | GitHub Settings â†’ Webhooks ä¸­å¯è§ |
| Webhook URL | âœ… å·²éªŒè¯ | `http://115.190.54.220:14808/github-webhook/` |
| Webhook è§¦å‘ | â³ å¾…æµ‹è¯• | éœ€è¦æ¨é€ä»£ç æµ‹è¯• |

### è¿æ¥ 3: Jenkins â†’ GitHub (ä»£ç æ‹‰å–)

| é¡¹ç›® | çŠ¶æ€ | éªŒè¯æ–¹å¼ |
|------|------|----------|
| Repository URL | âœ… å·²éªŒè¯ | `git@github.com:slk1061569042-lab/suntaya_server_blog.git` |
| Branch | âœ… å·²éªŒè¯ | `*/main` |
| Credential | âœ… å·²éªŒè¯ | `github-ssh-key` å·²é…ç½® |
| SSH Config | âœ… å·²éªŒè¯ | `/var/jenkins_home/.ssh/config` å·²åˆ›å»º |
| Known Hosts | âœ… å·²éªŒè¯ | GitHub ä¸»æœºå¯†é’¥å·²æ·»åŠ  |
| ä»£ç æ‹‰å– | â³ å¾…æµ‹è¯• | éœ€è¦è§¦å‘æ„å»ºæµ‹è¯• |

### è¿æ¥ 4: Jenkins â†’ Docker (æ„å»ºç¯å¢ƒ)

| é¡¹ç›® | çŠ¶æ€ | éªŒè¯æ–¹å¼ |
|------|------|----------|
| Docker Pipeline æ’ä»¶ | âš ï¸ éƒ¨åˆ†è§£å†³ | å·²å®‰è£…ï¼Œä½†ä¾èµ–å¾…éªŒè¯ |
| Docker Commons æ’ä»¶ | âœ… å·²å®‰è£… | å·²å®‰è£… |
| Authentication Tokens | âœ… å·²å®‰è£… | å·²å®‰è£… |
| Docker å¯ç”¨æ€§ | âœ… å·²éªŒè¯ | Jenkins å®¹å™¨å†…æœ‰ Docker (v29.1.3) |
| Agent é…ç½® | âœ… å·²éªŒè¯ | `agent { docker { image 'node:18-alpine' } }` |
| æ„å»ºæ‰§è¡Œ | â³ å¾…æµ‹è¯• | éœ€è¦è§¦å‘æ„å»ºæµ‹è¯• |

### è¿æ¥ 5: Jenkins â†’ æœåŠ¡å™¨ (éƒ¨ç½²)

| é¡¹ç›® | çŠ¶æ€ | éªŒè¯æ–¹å¼ |
|------|------|----------|
| Publish Over SSH | âœ… å·²éªŒè¯ | `main-server` é…ç½®æ­£ç¡® |
| SSH è¿æ¥ | âœ… å·²éªŒè¯ | åœ¨ Jenkins Web UI ä¸­æµ‹è¯•é€šè¿‡ |
| éƒ¨ç½²ç›®å½• | â³ å¾…éªŒè¯ | éœ€è¦æ£€æŸ¥ `/www/wwwroot/next.sunyas.com` æƒé™ |
| æ–‡ä»¶ä¸Šä¼  | â³ å¾…æµ‹è¯• | éœ€è¦è§¦å‘æ„å»ºæµ‹è¯• |

## ğŸ¯ é—®é¢˜å®šä½å›¾

```mermaid
graph LR
    A[æ„å»ºå¤±è´¥] --> B{æ£€æŸ¥é”™è¯¯ç±»å‹}
    
    B -->|æ’ä»¶é”™è¯¯| C[Docker Pipeline æ’ä»¶<br/>âš ï¸ ä¾èµ–é—®é¢˜]
    B -->|è¿æ¥é”™è¯¯| D[GitHub è¿æ¥<br/>âœ… å·²è§£å†³]
    B -->|æ„å»ºé”™è¯¯| E[æ„å»ºè¿‡ç¨‹<br/>â³ å¾…æµ‹è¯•]
    B -->|éƒ¨ç½²é”™è¯¯| F[SSH éƒ¨ç½²<br/>â³ å¾…æµ‹è¯•]
    
    C --> C1[ç¼ºå°‘ docker-commons<br/>âœ… å·²å®‰è£…]
    C1 --> C2[ç¼ºå°‘ authentication-tokens<br/>âœ… å·²å®‰è£…]
    C2 --> C3[å¾…éªŒè¯: é‡å¯åæ£€æŸ¥]
    
    D --> D1[ä¸»æœºå¯†é’¥éªŒè¯<br/>âœ… å·²è§£å†³]
    D --> D2[SSH Config<br/>âœ… å·²è§£å†³]
    D --> D3[Credential<br/>âœ… å·²è§£å†³]
    
    E --> E1[ä»£ç æ£€å‡º<br/>â³ å¾…æµ‹è¯•]
    E --> E2[ä¾èµ–å®‰è£…<br/>â³ å¾…æµ‹è¯•]
    E --> E3[æ„å»ºè¿‡ç¨‹<br/>â³ å¾…æµ‹è¯•]
    
    F --> F1[SSH è¿æ¥<br/>âœ… å·²éªŒè¯]
    F --> F2[æ–‡ä»¶ä¸Šä¼ <br/>â³ å¾…æµ‹è¯•]
    
    style A fill:#ff6b6b
    style C fill:#ffd700
    style C1 fill:#90ee90
    style C2 fill:#90ee90
    style C3 fill:#ffd700
    style D fill:#90ee90
    style D1 fill:#90ee90
    style D2 fill:#90ee90
    style D3 fill:#90ee90
    style E fill:#e1f5ff
    style F fill:#e1f5ff
    style F1 fill:#90ee90
```

## ğŸ“‹ éªŒè¯çŠ¶æ€æ±‡æ€»

### âœ… å·²éªŒè¯é€šè¿‡ï¼ˆç»¿è‰²ï¼‰

1. **GitHub é…ç½®**
   - SSH å…¬é’¥å·²æ·»åŠ 
   - Webhook å·²é…ç½®

2. **Jenkins åŸºç¡€é…ç½®**
   - Repository URL: `git@github.com:...`
   - Branch: `*/main`
   - Credential: `github-ssh-key`

3. **SSH è¿æ¥é…ç½®**
   - SSH Config: `github.com-new` â†’ `github.com`
   - Known Hosts: GitHub ä¸»æœºå¯†é’¥å·²æ·»åŠ 

4. **Jenkinsfile**
   - Agent: `agent { docker { image 'node:18-alpine' } }`
   - æ‰€æœ‰æ­¥éª¤å·²ç®€åŒ–

5. **éƒ¨ç½²é…ç½®**
   - Publish Over SSH: `main-server` å·²é…ç½®

### âš ï¸ å¾…éªŒè¯ï¼ˆé»„è‰²ï¼‰

1. **æ’ä»¶ä¾èµ–**
   - Docker Pipeline æ’ä»¶ä¾èµ–æ˜¯å¦å®Œå…¨è§£å†³
   - éœ€è¦é‡å¯ Jenkins åéªŒè¯

2. **æ„å»ºæµç¨‹**
   - ä»£ç æ‹‰å–æ˜¯å¦æˆåŠŸ
   - ä¾èµ–å®‰è£…æ˜¯å¦æˆåŠŸ
   - æ„å»ºæ˜¯å¦æˆåŠŸ
   - é™æ€å¯¼å‡ºæ˜¯å¦æˆåŠŸ

3. **éƒ¨ç½²æµç¨‹**
   - SSH éƒ¨ç½²æ˜¯å¦æˆåŠŸ
   - æ–‡ä»¶æ˜¯å¦æ­£ç¡®ä¸Šä¼ åˆ°éƒ¨ç½²ç›®å½•

### â³ å¾…æµ‹è¯•ï¼ˆç°è‰²ï¼‰

1. **è‡ªåŠ¨è§¦å‘**: Webhook è§¦å‘æ„å»º
2. **æ‰‹åŠ¨è§¦å‘**: åœ¨ Jenkins ä¸­æ‰‹åŠ¨è§¦å‘æ„å»º
3. **ç«¯åˆ°ç«¯æµ‹è¯•**: ä»ä»£ç æ¨é€åˆ°éƒ¨ç½²å®Œæˆçš„å®Œæ•´æµç¨‹

---

**å›¾ä¾‹**:
- âœ… ç»¿è‰²: å·²éªŒè¯é€šè¿‡
- âš ï¸ é»„è‰²: å¾…éªŒè¯/éƒ¨åˆ†è§£å†³
- â³ ç°è‰²: å¾…æµ‹è¯•
- âŒ çº¢è‰²: å¤±è´¥/é”™è¯¯
