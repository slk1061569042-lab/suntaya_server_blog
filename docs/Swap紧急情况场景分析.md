# Swap 紧急情况场景分析

**时间**: 2026-01-20  
**主题**: 什么情况下会出现内存不足，需要使用 Swap？

## 🔍 什么时候会出现紧急情况？

### 核心判断标准

**当物理内存使用率超过 90% 或可用内存少于 500 MB 时**，系统会开始使用 Swap。

---

## 📊 具体场景分析

### 场景 1: 并发构建任务 ⚠️ 最常见

**情况描述**：
- 同时触发多个构建任务
- 或者构建任务排队执行，但内存未及时释放

**内存消耗**：
```
物理内存: 7.8 GiB
├─ Jenkins 主进程: ~1 GiB
├─ 构建任务 1 (Docker): ~2 GiB
├─ 构建任务 2 (Docker): ~2 GiB
├─ 构建任务 3 (Docker): ~2 GiB
├─ 系统缓存: ~1 GiB
└─ 可用内存: ~0.8 GiB ⚠️

结果: 开始使用 Swap
```

**触发条件**：
- ✅ 手动同时触发多个构建
- ✅ GitHub 推送触发构建，但上一个构建未完成
- ✅ 多个分支同时构建
- ✅ 构建任务执行时间长，内存未释放

**你的项目风险**：
- ⚠️ **中等风险**：单个 Next.js 构建通常 5-10 分钟
- ⚠️ 如果快速连续推送代码，可能并发构建
- ✅ 当前配置：Jenkins 默认会排队执行，降低风险

---

### 场景 2: 大型项目构建 ⚠️ 项目增长时

**情况描述**：
- 项目代码量增加
- 依赖包增多（node_modules 变大）
- Next.js 构建需要更多内存

**内存消耗**：
```
物理内存: 7.8 GiB
├─ Jenkins 主进程: ~1 GiB
├─ 大型构建任务: ~4-5 GiB ⚠️
│   ├─ node_modules: ~1 GiB
│   ├─ 构建缓存: ~1 GiB
│   ├─ 编译过程: ~2 GiB
│   └─ Docker 容器: ~1 GiB
├─ 系统缓存: ~1 GiB
└─ 可用内存: ~0.8 GiB ⚠️

结果: 开始使用 Swap
```

**触发条件**：
- ✅ 项目依赖包超过 1000 个
- ✅ 项目代码超过 10 万行
- ✅ 使用大量图片资源（构建时需要处理）
- ✅ Next.js 构建缓存累积

**你的项目风险**：
- ✅ **当前低风险**：项目规模较小
- ⚠️ **未来可能**：随着项目增长，风险增加
- 💡 **建议**：定期清理构建缓存

---

### 场景 3: 服务器运行其他服务 ⚠️ 多服务环境

**情况描述**：
- 服务器上运行多个服务
- 其他服务占用内存
- Jenkins 构建时内存不足

**内存消耗**：
```
物理内存: 7.8 GiB
├─ 其他服务 1 (如 Nginx): ~500 MB
├─ 其他服务 2 (如 MySQL): ~1 GiB
├─ 其他服务 3 (如 Redis): ~500 MB
├─ Jenkins 主进程: ~1 GiB
├─ 构建任务: ~2 GiB
├─ 系统缓存: ~1 GiB
└─ 可用内存: ~1.3 GiB ⚠️

如果其他服务内存增加 → 可用内存 < 500 MB → 使用 Swap
```

**触发条件**：
- ✅ 服务器运行多个应用
- ✅ 其他服务内存使用突然增加（如数据库查询量大）
- ✅ 系统缓存占用增加

**你的项目风险**：
- ⚠️ **需要确认**：服务器上是否运行其他服务
- 💡 **建议**：监控其他服务的内存使用

---

### 场景 4: 构建过程内存泄漏 ⚠️ 代码问题

**情况描述**：
- 构建脚本有内存泄漏
- 构建过程中内存持续增长
- 最终耗尽内存

**内存消耗**：
```
构建开始: ~1 GiB ✅
构建 5 分钟: ~2 GiB ⚠️
构建 10 分钟: ~3 GiB ⚠️
构建 15 分钟: ~4 GiB ⚠️
构建 20 分钟: ~5 GiB ❌

结果: 内存耗尽，必须使用 Swap
```

**触发条件**：
- ✅ 构建脚本有循环引用
- ✅ 大量数据未及时释放
- ✅ 构建工具 bug（如 webpack 内存泄漏）

**你的项目风险**：
- ✅ **当前低风险**：Next.js 构建通常稳定
- ⚠️ **注意**：如果构建时间异常长，可能是内存泄漏

---

### 场景 5: 系统更新或维护 ⚠️ 系统操作

**情况描述**：
- 系统更新占用内存
- 系统维护任务运行
- 临时文件清理占用内存

**内存消耗**：
```
物理内存: 7.8 GiB
├─ Jenkins: ~1 GiB
├─ 构建任务: ~2 GiB
├─ 系统更新进程: ~1 GiB ⚠️
├─ 系统缓存: ~2 GiB
└─ 可用内存: ~1.8 GiB ⚠️

如果构建任务内存增加 → 使用 Swap
```

**触发条件**：
- ✅ 系统自动更新
- ✅ 手动执行系统维护
- ✅ 日志轮转或清理任务

**你的项目风险**：
- ⚠️ **低风险**：通常不会同时发生
- 💡 **建议**：避免在构建高峰期进行系统维护

---

### 场景 6: Docker 镜像拉取和构建 ⚠️ 首次构建

**情况描述**：
- 首次构建需要拉取 Docker 镜像
- 镜像拉取占用内存
- 同时进行构建任务

**内存消耗**：
```
物理内存: 7.8 GiB
├─ Jenkins: ~1 GiB
├─ 拉取 Docker 镜像: ~1 GiB ⚠️
├─ 构建任务: ~2 GiB
├─ 系统缓存: ~1 GiB
└─ 可用内存: ~2.8 GiB ✅

如果镜像很大或同时多个镜像 → 可能使用 Swap
```

**触发条件**：
- ✅ 首次使用新的 Docker 镜像
- ✅ 镜像更新需要重新拉取
- ✅ 同时拉取多个镜像

**你的项目风险**：
- ✅ **低风险**：`node:20-alpine` 镜像较小（~100 MB）
- ✅ 镜像拉取后会被缓存

---

## 📊 你的服务器实际情况分析

### 当前内存使用

```bash
物理内存: 7.8 GiB
├─ 已使用: ~5.3 GiB (68%)
├─ 可用: ~2.4 GiB (32%)
└─ 使用率: 68% ✅ 安全

Swap: 4.0 GiB
└─ 已使用: 0 B ✅ 未使用
```

### 触发 Swap 的临界点

**计算**：
- 当前可用: 2.4 GiB
- 单个构建任务: ~2 GiB
- **临界点**: 可用内存 < 500 MB

**触发条件**：
```
当前可用: 2.4 GiB
- 构建任务 1: -2 GiB
= 剩余: 0.4 GiB ⚠️ 接近临界点

如果再启动一个构建任务:
剩余: 0.4 GiB
- 构建任务 2: -2 GiB
= -1.6 GiB ❌ 必须使用 Swap
```

---

## 🎯 最可能出现的紧急情况

### 排名 1: 并发构建 ⭐⭐⭐⭐⭐

**概率**: 高  
**影响**: 中等  
**预防**: 
- ✅ 配置 Jenkins 构建队列
- ✅ 限制并发构建数量
- ✅ 监控构建任务状态

### 排名 2: 项目规模增长 ⭐⭐⭐⭐

**概率**: 中  
**影响**: 高  
**预防**: 
- 定期清理构建缓存
- 优化构建配置
- 监控项目规模

### 排名 3: 服务器其他服务 ⭐⭐⭐

**概率**: 中  
**影响**: 中等  
**预防**: 
- 监控所有服务内存使用
- 合理分配服务器资源
- 考虑服务隔离

---

## 🔧 如何预防和监控？

### 预防措施

1. **配置构建队列**
   ```groovy
   // 在 Jenkinsfile 中限制并发
   options {
       disableConcurrentBuilds()
   }
   ```

2. **监控内存使用**
   ```bash
   # 定期检查
   free -h
   
   # 监控构建任务内存
   docker stats
   ```

3. **优化构建配置**
   - 定期清理 node_modules
   - 使用构建缓存
   - 优化 Next.js 构建配置

### 监控告警

**建议设置告警**：
- ⚠️ 可用内存 < 1 GiB：警告
- ❌ 可用内存 < 500 MB：严重警告
- ❌ Swap 使用 > 2 GiB：需要关注

---

## 📋 总结

### 什么时候会出现紧急情况？

**最可能的情况**：
1. ⭐⭐⭐⭐⭐ **并发构建**：同时运行 2 个以上构建任务
2. ⭐⭐⭐⭐ **大型构建**：项目规模增长，单个构建需要 > 3 GiB
3. ⭐⭐⭐ **多服务环境**：服务器运行多个服务，内存被占用

**你的当前风险**：
- ✅ **低风险**：当前内存充足（2.4 GiB 可用）
- ✅ **已保护**：Swap 已配置（4.0 GiB）
- ⚠️ **注意**：避免同时运行多个构建任务

### 简单判断

**如果出现以下情况，可能触发 Swap**：
- ✅ 同时运行 2 个构建任务
- ✅ 构建任务执行时间 > 15 分钟
- ✅ 服务器其他服务内存使用增加
- ✅ 项目依赖包数量 > 1000 个

---

**最后更新**: 2026-01-20
