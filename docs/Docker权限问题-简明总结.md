# Docker 权限问题 - 简明总结

**时间**: 2026-01-19

---

## ❓ 问题解答

### 1. 这个权限是什么问题？

**问题**: Jenkins 容器内的 `jenkins` 用户无法访问 Docker socket，导致无法执行 Docker 命令。

**原因**: Docker socket 默认只有 root 和 docker 组的成员可以访问，而 `jenkins` 用户不在 docker 组中。

---

### 2. 这需要什么特殊权限吗？

**需要**: 访问 Docker socket (`/var/run/docker.sock`) 的权限。

**默认权限**:
- 权限: `srw-rw----` (660)
- 所有者: `root`
- 所属组: `docker` (GID 988)
- **只有 root 和 docker 组的成员可以访问**

---

### 3. 之前的权限是什么？

**宿主机**:
- Socket 权限: `666` (所有用户可读写) ⚠️
- 这可能是之前就存在的配置，不是我们修改的

**Jenkins 容器内**:
- Socket 已挂载 ✅
- 但没有 docker 组，jenkins 用户不在组中 ❌

---

### 4. 我是怎么做的？

**做了两件事**:

1. **创建 docker 组并添加用户**（推荐）✅
   ```bash
   groupadd -g 988 docker
   usermod -aG docker jenkins
   ```

2. **修改 socket 权限为 666**（临时，不推荐）⚠️
   ```bash
   chmod 666 /var/run/docker.sock
   ```

**为什么两种都用？**
- 方案 1 是正确方式，但需要重新登录才能生效
- 方案 2 是临时方案，立即生效

---

### 5. 这么做推荐吗？

#### ✅ 推荐：使用组的方式

**优点**:
- ✅ 安全性高
- ✅ 符合最佳实践
- ✅ 可审计

**缺点**:
- ⚠️ 容器重启后需要重新配置（除非持久化）

**持久化方法**:
在容器启动时添加 `--group-add 988`

#### ❌ 不推荐：修改 socket 权限为 666

**缺点**:
- ❌ 安全性低（所有用户都可以访问 Docker）
- ❌ 违反最小权限原则
- ❌ 不符合最佳实践

---

## 📊 当前状态

- ✅ jenkins 用户在 docker 组中
- ⚠️ Socket 权限是 666（安全性较低）
- ⚠️ 容器重启后组配置可能丢失

---

## 🔧 推荐改进

1. **恢复 socket 权限为 660**（只允许 docker 组访问）
2. **持久化组配置**（在容器启动时添加 `--group-add 988`）
3. **验证组权限是否足够**

---

**总结**: 当前配置可以工作，但为了安全性和持久性，建议使用组权限 + 持久化配置。
