# 502 é”™è¯¯ä¿®å¤å®Œæˆ

**æ—¶é—´**: 2026-01-20  
**é—®é¢˜**: æ„å»ºæˆåŠŸä½†ç½‘ç«™æ˜¾ç¤º 502 é”™è¯¯  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

## ğŸ” é—®é¢˜è¯Šæ–­

### ç—‡çŠ¶

1. **PM2 çŠ¶æ€**: `errored`ï¼ˆå¯åŠ¨å¤±è´¥ï¼Œé‡å¯ 15 æ¬¡ï¼‰
2. **é”™è¯¯æ—¥å¿—**: 
   ```
   Error: ENOENT: no such file or directory, open '/www/wwwroot/next.sunyas.com/.next/routes-manifest.json'
   ```
3. **ç«¯å£ç›‘å¬**: 3000 ç«¯å£æœªç›‘å¬ï¼ˆåº”ç”¨æœªå¯åŠ¨ï¼‰
4. **ç›®å½•ç»“æ„**: `.next` ç›®å½•åªæœ‰ `BUILD_ID` æ–‡ä»¶ï¼Œç¼ºå°‘å…¶ä»–å¿…è¦æ–‡ä»¶

---

## âŒ é—®é¢˜æ ¹æº

### Jenkinsfile æ‰“åŒ…é€»è¾‘é”™è¯¯

**é”™è¯¯çš„æ‰“åŒ…é€»è¾‘**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
```groovy
# å¤åˆ¶ standalone æ–‡ä»¶
cp -r .next/standalone/* deploy-package/

# å¤åˆ¶ .next ç›®å½•
mkdir -p deploy-package/.next
cp -r .next/standalone deploy-package/.next/  # âŒ é”™è¯¯
cp -r .next/static deploy-package/.next/     # âœ… æ­£ç¡®
cp .next/BUILD_ID deploy-package/.next/      # âœ… æ­£ç¡®
```

**é—®é¢˜**ï¼š
- åªå¤åˆ¶äº† `static` å’Œ `BUILD_ID`
- **ç¼ºå°‘ `routes-manifest.json`** ç­‰å¿…è¦æ–‡ä»¶
- Next.js standalone æ¨¡å¼éœ€è¦å®Œæ•´çš„ `.next` ç›®å½•ç»“æ„

**éƒ¨ç½²åçš„ç›®å½•ç»“æ„**ï¼ˆé”™è¯¯ï¼‰ï¼š
```
/www/wwwroot/next.sunyas.com/
â”œâ”€â”€ server.js          âœ…
â”œâ”€â”€ package.json       âœ…
â”œâ”€â”€ .next/
â”‚   â”œâ”€â”€ BUILD_ID       âœ…
â”‚   â”œâ”€â”€ static/        âœ…
â”‚   â””â”€â”€ (ç¼ºå°‘ routes-manifest.json) âŒ
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤åçš„æ‰“åŒ…é€»è¾‘

```groovy
# 1. å¤åˆ¶ standalone ç›®å½•å†…å®¹åˆ°éƒ¨ç½²åŒ…æ ¹ç›®å½•
cp -r .next/standalone/* deploy-package/

# 2. å¤åˆ¶æ•´ä¸ª .next ç›®å½•ï¼ˆåŒ…å«æ‰€æœ‰å¿…è¦æ–‡ä»¶ï¼‰
cp -r .next deploy-package/

# 3. åˆ é™¤ deploy-package/.next/standaloneï¼ˆå› ä¸º standalone å†…å®¹å·²åœ¨æ ¹ç›®å½•ï¼‰
rm -rf deploy-package/.next/standalone
```

**ä¿®å¤åçš„ç›®å½•ç»“æ„**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```
/www/wwwroot/next.sunyas.com/
â”œâ”€â”€ server.js              âœ… (æ¥è‡ª standalone)
â”œâ”€â”€ package.json           âœ…
â”œâ”€â”€ node_modules/          âœ… (æ¥è‡ª standaloneï¼Œæœ€å°åŒ–ä¾èµ–)
â”œâ”€â”€ .next/
â”‚   â”œâ”€â”€ BUILD_ID           âœ…
â”‚   â”œâ”€â”€ static/            âœ…
â”‚   â”œâ”€â”€ routes-manifest.json âœ… (ç°åœ¨æœ‰äº†)
â”‚   â”œâ”€â”€ prerender-manifest.json âœ…
â”‚   â””â”€â”€ (å…¶ä»–å¿…è¦æ–‡ä»¶)      âœ…
```

---

## ğŸ“‹ Next.js Standalone æ¨¡å¼éƒ¨ç½²è¦æ±‚

### å¿…éœ€çš„æ–‡ä»¶ç»“æ„

1. **æ ¹ç›®å½•**ï¼ˆæ¥è‡ª `.next/standalone/*`ï¼‰ï¼š
   - `server.js` - Next.js æœåŠ¡å™¨å…¥å£
   - `node_modules/` - æœ€å°åŒ–ä¾èµ–
   - å…¶ä»– standalone æ–‡ä»¶

2. **`.next` ç›®å½•**ï¼ˆæ¥è‡ª `.next/`ï¼‰ï¼š
   - `BUILD_ID` - æ„å»º ID
   - `static/` - é™æ€èµ„æº
   - `routes-manifest.json` - è·¯ç”±æ¸…å•ï¼ˆ**å¿…éœ€**ï¼‰
   - `prerender-manifest.json` - é¢„æ¸²æŸ“æ¸…å•
   - å…¶ä»–æ„å»ºå…ƒæ•°æ®

---

## ğŸ”§ ä¿®å¤æ­¥éª¤

### å·²å®Œæˆçš„ä¿®å¤

1. âœ… ä¿®æ”¹ Jenkinsfile æ‰“åŒ…é€»è¾‘
2. âœ… æäº¤å¹¶æ¨é€åˆ° GitHub
3. â³ ç­‰å¾… Jenkins è‡ªåŠ¨è§¦å‘æ„å»ºï¼ˆæˆ–æ‰‹åŠ¨è§¦å‘ï¼‰

### éªŒè¯ä¿®å¤

æ„å»ºå®Œæˆåï¼Œæ£€æŸ¥ï¼š

```bash
# 1. æ£€æŸ¥ .next ç›®å½•ç»“æ„
ssh root@115.190.54.220 "ls -la /www/wwwroot/next.sunyas.com/.next/"

# åº”è¯¥çœ‹åˆ°ï¼š
# - BUILD_ID
# - static/
# - routes-manifest.json âœ…
# - prerender-manifest.json âœ…

# 2. æ£€æŸ¥ PM2 çŠ¶æ€
ssh root@115.190.54.220 "pm2 list"
# åº”è¯¥æ˜¾ç¤ºï¼šonline âœ…

# 3. æ£€æŸ¥ç«¯å£ç›‘å¬
ssh root@115.190.54.220 "netstat -tlnp | grep 3000"
# åº”è¯¥æ˜¾ç¤ºï¼šLISTEN âœ…

# 4. æ£€æŸ¥åº”ç”¨æ—¥å¿—
ssh root@115.190.54.220 "pm2 logs next-sunyas --lines 20 --nostream"
# åº”è¯¥æ²¡æœ‰é”™è¯¯ âœ…
```

---

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤åï¼š

1. âœ… **æ„å»ºæˆåŠŸ** - Jenkins æ„å»ºé€šè¿‡
2. âœ… **æ–‡ä»¶å®Œæ•´** - `.next` ç›®å½•åŒ…å«æ‰€æœ‰å¿…è¦æ–‡ä»¶
3. âœ… **åº”ç”¨å¯åŠ¨** - PM2 çŠ¶æ€ä¸º `online`
4. âœ… **ç«¯å£ç›‘å¬** - 3000 ç«¯å£æ­£å¸¸ç›‘å¬
5. âœ… **ç½‘ç«™æ­£å¸¸** - ä¸å†æ˜¾ç¤º 502 é”™è¯¯

---

## ğŸ“Š é—®é¢˜æ€»ç»“

### é—®é¢˜ç±»å‹

**é…ç½®é”™è¯¯** - Jenkinsfile æ‰“åŒ…é€»è¾‘ä¸å®Œæ•´

### æ ¹æœ¬åŸå› 

- Next.js standalone æ¨¡å¼éœ€è¦å®Œæ•´çš„ `.next` ç›®å½•ç»“æ„
- ä¹‹å‰çš„æ‰“åŒ…é€»è¾‘åªå¤åˆ¶äº†éƒ¨åˆ†æ–‡ä»¶
- ç¼ºå°‘ `routes-manifest.json` ç­‰å…³é”®æ–‡ä»¶

### è§£å†³æ–¹æ¡ˆ

- å¤åˆ¶æ•´ä¸ª `.next` ç›®å½•
- åˆ é™¤é‡å¤çš„ `standalone` å­ç›®å½•
- ç¡®ä¿æ‰€æœ‰å¿…è¦æ–‡ä»¶éƒ½åœ¨æ­£ç¡®ä½ç½®

---

**ä¿®å¤æäº¤**: `025c141`  
**ä¸‹ä¸€æ­¥**: ç­‰å¾… Jenkins è‡ªåŠ¨æ„å»ºï¼Œæˆ–æ‰‹åŠ¨è§¦å‘æ„å»ºæµ‹è¯•

---

**æœ€åæ›´æ–°**: 2026-01-20
