# 文件部署路径问题说明

**时间**: 2026-01-20  
**问题**: 文件被部署到错误的子目录 `www/wwwroot/next.sunyas.com/` 而不是 `/www/wwwroot/next.sunyas.com/`

## 🔍 问题原因分析

### Jenkins Publish Over SSH 插件的行为

**Jenkinsfile 配置**（第 179 行）：
```groovy
remoteDirectory: deployDir,  // deployDir = '/www/wwwroot/next.sunyas.com'
```

**问题**：
- Jenkins 的 Publish Over SSH 插件在处理 `remoteDirectory` 时，会**在 SSH 配置的默认远程目录基础上拼接路径**
- 如果 SSH 配置中设置了默认远程目录（如 `/www`），那么：
  - 配置的 `remoteDirectory`: `/www/wwwroot/next.sunyas.com`
  - 实际部署路径: `/www` + `/www/wwwroot/next.sunyas.com` = `/www/www/wwwroot/next.sunyas.com`
  - 或者：默认目录 + 相对路径 = 错误的位置

**实际发生的情况**：
```
期望位置: /www/wwwroot/next.sunyas.com/
实际位置: /www/wwwroot/next.sunyas.com/www/wwwroot/next.sunyas.com/
```

---

## 📋 文件来源说明

### 我没有复制文件，而是移动了文件

**实际情况**：
1. **Jenkins 自动部署**：文件是通过 Jenkins 的 Publish Over SSH 插件自动上传的
2. **文件位置错误**：文件被上传到了错误的子目录
3. **我执行的操作**：通过 SSH 命令将文件从错误位置移动到正确位置

**执行的命令**：
```bash
# 检查是否有错误的子目录
if [ -d 'www/wwwroot/next.sunyas.com' ]; then
  # 移动 .next 目录中的文件
  mv www/wwwroot/next.sunyas.com/.next/* .next/
  mv www/wwwroot/next.sunyas.com/.next/.* .next/
  # 移动其他文件
  mv www/wwwroot/next.sunyas.com/* .
  mv www/wwwroot/next.sunyas.com/.* .
  # 删除错误的子目录
  rm -rf www
fi
```

**文件来源**：
- ✅ **来自 Jenkins 构建**：在 Docker 容器中构建的 `deploy-package/` 目录
- ✅ **通过 SSH 上传**：Jenkins 的 Publish Over SSH 插件上传到服务器
- ❌ **不是手动复制**：我没有手动复制任何文件

---

## 🔧 文件构建和部署流程

### 完整的文件流程

```
1. 本地代码 (GitHub)
   ↓
2. Jenkins 检出代码
   ↓
3. Docker 容器构建
   ├── npm install
   ├── npm run build
   └── 创建 deploy-package/
       ├── server.js (来自 .next/standalone/)
       ├── .next/ (完整目录)
       ├── node_modules/ (最小化依赖)
       ├── package.json
       └── public/
   ↓
4. Jenkins Publish Over SSH 插件
   ├── 上传 deploy-package/** 到服务器
   ├── removePrefix: 'deploy-package' (去掉前缀)
   └── remoteDirectory: '/www/wwwroot/next.sunyas.com'
   ↓
5. 服务器上的文件位置
   ❌ 错误: /www/wwwroot/next.sunyas.com/www/wwwroot/next.sunyas.com/
   ✅ 正确: /www/wwwroot/next.sunyas.com/
```

---

## 🎯 为什么会到错误目录？

### 可能的原因

#### 原因 1: SSH 配置的默认远程目录

**Jenkins SSH 配置**（Manage Jenkins → Configure System → Publish over SSH）：
- 如果 `main-server` 配置中设置了 **Remote Directory**（如 `/www`）
- 那么 `remoteDirectory` 会被当作**相对路径**拼接

**示例**：
```
SSH 配置的 Remote Directory: /www
Jenkinsfile 的 remoteDirectory: /www/wwwroot/next.sunyas.com
实际路径: /www + /www/wwwroot/next.sunyas.com = /www/www/wwwroot/next.sunyas.com
```

#### 原因 2: 绝对路径被当作相对路径

某些版本的 Publish Over SSH 插件可能：
- 将绝对路径 `/www/wwwroot/next.sunyas.com` 当作相对路径
- 在 SSH 配置的默认目录基础上拼接

---

## ✅ 解决方案

### 方案 1: 修复 SSH 配置（推荐）

**步骤**：
1. 打开 Jenkins：Manage Jenkins → Configure System
2. 找到 Publish over SSH 配置
3. 找到 `main-server` 配置
4. **清空或设置 Remote Directory 为空**（或设置为 `/`）
5. 保存配置

**这样**：
- `remoteDirectory: '/www/wwwroot/next.sunyas.com'` 会被当作绝对路径
- 文件会直接部署到 `/www/wwwroot/next.sunyas.com/`

---

### 方案 2: 使用相对路径

**修改 Jenkinsfile**：
```groovy
// 如果 SSH 配置的 Remote Directory 是 /www
remoteDirectory: 'wwwroot/next.sunyas.com',  // 使用相对路径
```

**这样**：
- 实际路径 = `/www` + `wwwroot/next.sunyas.com` = `/www/wwwroot/next.sunyas.com/`

---

### 方案 3: 在部署脚本中处理（当前方案）

**Jenkinsfile 中已有处理逻辑**（第 184 行）：
```groovy
execCommand: """... && if [ -d 'www/wwwroot/next.sunyas.com' ]; then 
  echo '===> 检测到文件在子目录中，正在移动到正确位置...' 
  mv www/wwwroot/next.sunyas.com/* . 
  mv www/wwwroot/next.sunyas.com/.* . 
  rm -rf www 
  echo '===> 文件已移动到正确位置'
fi && ..."""
```

**优点**：
- ✅ 自动修复路径问题
- ✅ 不需要修改 SSH 配置
- ✅ 兼容不同的 SSH 配置

**缺点**：
- ⚠️ 每次部署都要移动文件（效率稍低）
- ⚠️ 如果路径正确，这个逻辑不会执行（无害）

---

## 📊 当前状态

### 文件已移动到正确位置

**当前目录结构**：
```
/www/wwwroot/next.sunyas.com/
├── server.js          ✅
├── package.json       ✅
├── .next/             ✅ (包含所有必要文件)
│   ├── routes-manifest.json ✅
│   ├── static/        ✅
│   ├── BUILD_ID       ✅
│   └── ...
├── node_modules/      ✅
└── public/            ✅
```

**应用状态**：
- ✅ PM2: `online`
- ✅ 端口 3000: 正常监听
- ✅ 应用正常运行

---

## 🔧 建议的修复

### 推荐：检查并修复 SSH 配置

1. **检查 Jenkins SSH 配置**：
   - 访问：Manage Jenkins → Configure System → Publish over SSH
   - 找到 `main-server` 配置
   - 检查 **Remote Directory** 字段

2. **如果设置了值**（如 `/www`）：
   - **选项 A**：清空 Remote Directory，使用绝对路径
   - **选项 B**：修改 Jenkinsfile 使用相对路径

3. **测试部署**：
   - 触发一次构建
   - 检查文件是否直接部署到正确位置
   - 如果正确，可以移除 Jenkinsfile 中的移动逻辑

---

## 📝 总结

### 文件来源
- ✅ **来自 Jenkins 构建**：在 Docker 容器中构建
- ✅ **通过 SSH 上传**：Jenkins 插件自动上传
- ❌ **不是手动复制**：我没有手动复制文件

### 文件位置错误的原因
- ⚠️ **SSH 配置问题**：默认远程目录 + 绝对路径 = 错误拼接
- ⚠️ **插件行为**：某些版本的插件可能将绝对路径当作相对路径

### 当前解决方案
- ✅ **自动修复**：Jenkinsfile 中的脚本自动移动文件
- ✅ **应用正常**：文件已在正确位置，应用正常运行

### 长期解决方案
- 🔧 **修复 SSH 配置**：清空或调整 Remote Directory
- 🔧 **优化部署脚本**：确保文件直接部署到正确位置

---

**最后更新**: 2026-01-20
