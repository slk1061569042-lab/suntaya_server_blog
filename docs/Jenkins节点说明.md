# Jenkins 节点说明

**时间**: 2026-01-20  
**主题**: Jenkins 节点的作用和分类

## 📊 什么是 Jenkins 节点？

**节点（Node）**是 Jenkins 中执行构建任务的**执行环境**。可以理解为"工作机器"或"构建代理"。

---

## 🔍 节点类型

### 1. Master 节点（主节点）

**作用**：
- ✅ **Jenkins 控制中心**：管理整个 Jenkins 系统
- ✅ **Web 界面**：提供 Jenkins Web UI（http://115.190.54.220:14808）
- ✅ **任务调度**：分配构建任务到各个节点
- ✅ **配置管理**：存储 Job 配置、插件、凭据等
- ✅ **可以直接执行构建**：如果没有配置 Agent，Master 也可以执行构建任务

**在你的项目中**：
- **节点名称**: `master`
- **位置**: 运行在 Docker 容器中（`jenkins_hwfa-jenkins_hWFA-1`）
- **作用**: 
  - 接收 GitHub Webhook 触发构建
  - 管理构建任务（`suntaya-server-blog`）
  - 执行构建流程（通过 Docker Agent）

---

### 2. Agent 节点（代理节点/从节点）

**作用**：
- ✅ **执行构建任务**：实际运行构建脚本
- ✅ **分担 Master 负载**：避免 Master 节点过载
- ✅ **分布式构建**：可以在多台机器上并行构建
- ✅ **环境隔离**：不同 Agent 可以有不同的构建环境

**类型**：
1. **静态 Agent**：手动配置的固定节点
2. **动态 Agent**：按需创建的临时节点（如 Docker Agent）

---

## 🎯 在你的项目中的节点架构

### 当前配置

```
┌─────────────────────────────────────┐
│  Master 节点 (jenkins_hwfa-jenkins) │
│  - 运行 Jenkins Web UI              │
│  - 管理 Job 配置                    │
│  - 接收 Webhook 触发                │
└──────────────┬──────────────────────┘
               │
               │ 分配任务
               ▼
┌─────────────────────────────────────┐
│  Docker Agent (node:20-alpine)     │
│  - 临时创建的容器                   │
│  - 执行构建任务                     │
│  - 运行 npm install/build/export   │
└─────────────────────────────────────┘
```

### 工作流程

1. **GitHub Webhook 触发** → Master 节点接收
2. **Master 节点调度** → 创建 Docker Agent
3. **Docker Agent 执行**：
   - 检出代码
   - 安装依赖
   - 构建 Next.js
   - 静态导出
4. **Master 节点部署** → 通过 SSH 部署到服务器

---

## 📋 节点列表页面显示的信息

在 **系统管理 → 节点列表** 页面，你可以看到：

| 列名 | 说明 | 作用 |
|------|------|------|
| **名称** | 节点名称 | 标识节点（如 `master`） |
| **架构** | 系统架构 | 显示操作系统和 CPU 架构（如 `Linux (amd64)`） |
| **时钟差异** | 时间同步状态 | 检查节点时间是否同步 |
| **剩余磁盘空间** | 可用磁盘空间 | 监控磁盘使用情况，避免磁盘满导致构建失败 |
| **剩余交换空间** | 可用 Swap 空间 | **重要**：监控内存溢出保护，防止 OOM Killer |
| **剩余交换空间** | 可用 Swap 空间 | 监控内存溢出保护 |
| **剩余临时空间** | 临时文件空间 | 监控临时文件使用情况 |
| **响应时间** | 节点响应速度 | 检查节点是否在线和响应速度 |

---

## ⚠️ 为什么监控这些资源？

### 1. 剩余交换空间（Swap）

**为什么重要**：
- ✅ **内存溢出保护**：当物理内存不足时，系统可以使用 Swap 作为缓冲
- ✅ **防止 OOM Killer**：避免进程被强制终止
- ✅ **构建任务稳定性**：大型构建任务需要大量内存，Swap 提供保护

**你的情况**：
- ✅ 已配置 4GB Swap
- ✅ 容器可以访问 Swap
- ✅ 系统在内存不足时会自动使用 Swap

### 2. 剩余磁盘空间

**为什么重要**：
- ✅ **构建产物存储**：需要空间存储构建输出
- ✅ **Docker 镜像**：需要空间存储 Docker 镜像和容器
- ✅ **日志文件**：Jenkins 日志和构建日志需要空间

### 3. 时钟差异

**为什么重要**：
- ✅ **构建时间戳**：确保构建日志时间准确
- ✅ **文件时间戳**：避免文件时间不一致问题
- ✅ **分布式构建**：多节点时间同步很重要

---

## 🔧 节点配置示例

### Master 节点配置

在你的项目中，Master 节点：
- **运行方式**: Docker 容器
- **容器名**: `jenkins_hwfa-jenkins_hWFA-1`
- **端口映射**: 
  - `14808:8080` (Web UI)
  - `50000:50000` (Agent 通信)
- **数据持久化**: `/var/jenkins_home` (挂载到宿主机)

### Docker Agent 配置

在你的 `Jenkinsfile` 中：

```groovy
agent {
    docker {
        image 'node:20-alpine'  // 使用 Node.js 20 镜像
        args '-u root:root'      // 使用 root 用户避免权限问题
    }
}
```

**工作方式**：
1. Master 节点接收到构建任务
2. 创建一个临时的 Docker 容器（`node:20-alpine`）
3. 在容器内执行构建步骤
4. 构建完成后，容器自动删除

**优点**：
- ✅ **环境隔离**：每次构建都是干净的环境
- ✅ **无需安装依赖**：不需要在 Master 上安装 Node.js
- ✅ **版本控制**：可以指定 Node.js 版本
- ✅ **资源清理**：构建完成后自动清理

---

## 🎯 总结

### Master 节点（你看到的 `master`）

**作用**：
- 🎛️ **控制中心**：管理整个 Jenkins 系统
- 📊 **监控节点**：监控系统资源（磁盘、内存、Swap 等）
- 🔄 **任务调度**：分配构建任务
- 💾 **数据存储**：存储配置、日志、构建历史

**监控信息**：
- 剩余交换空间：**4.0 GiB** ✅（已修复）
- 剩余磁盘空间：31.06 GiB
- 架构：Linux (amd64)
- 时钟差异：已同步

### Docker Agent（临时节点）

**作用**：
- 🏗️ **执行构建**：实际运行构建脚本
- 🧹 **环境隔离**：每次构建都是干净环境
- 🚀 **自动清理**：构建完成后自动删除

**生命周期**：
1. 构建开始 → 创建容器
2. 执行构建 → 在容器内运行命令
3. 构建完成 → 删除容器

---

## 📚 相关概念

### 节点 vs Job

- **节点（Node）**：执行构建任务的**机器/环境**
- **Job**：构建任务的**配置和流程**（如 `suntaya-server-blog`）

### 节点 vs Agent

- **节点（Node）**：通用术语，指所有执行环境
- **Agent**：特指执行构建任务的节点（相对于 Master）

---

**最后更新**: 2026-01-20
