<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Excel æ•°æ®åˆ†æé¢æ¿</title>
    
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 22px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 13px;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .section-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .stat-card {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 15px;
        }
        
        .data-preview {
            margin-top: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .select-range-btn {
            background: #28a745;
            margin-bottom: 15px;
        }
        
        .select-range-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Excel æ•°æ®åˆ†æé¢æ¿</h1>
        <p class="subtitle">æ™ºèƒ½åˆ†æ Excel æ•°æ®å¹¶ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</p>
        
        <div class="section">
            <div class="section-title">1. é€‰æ‹©æ•°æ®èŒƒå›´</div>
            <button class="btn select-range-btn" id="selectRangeBtn">ğŸ“ é€‰æ‹©æ•°æ®èŒƒå›´</button>
            <div id="rangeInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
        </div>
        
        <div class="section">
            <div class="section-title">2. æ•°æ®ç»Ÿè®¡</div>
            <div class="stat-card" id="statsCard">
                <div class="stat-item">
                    <div class="stat-value" id="rowCount">-</div>
                    <div class="stat-label">æ•°æ®è¡Œæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="colCount">-</div>
                    <div class="stat-label">æ•°æ®åˆ—æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="sumValue">-</div>
                    <div class="stat-label">æ•°å€¼æ€»å’Œ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgValue">-</div>
                    <div class="stat-label">å¹³å‡å€¼</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">3. æ•°æ®å¯è§†åŒ–</div>
            <div class="chart-container">
                <canvas id="dataChart"></canvas>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">4. æ•°æ®é¢„è§ˆ</div>
            <div class="data-preview" id="dataPreview">è¯·å…ˆé€‰æ‹©æ•°æ®èŒƒå›´</div>
        </div>
        
        <button class="btn" id="analyzeBtn" disabled>ğŸ” å¼€å§‹åˆ†æ</button>
        <button class="btn" id="insertChartBtn" disabled style="background: #17a2b8; margin-top: 10px;">ğŸ“ˆ æ’å…¥å›¾è¡¨åˆ° Excel</button>
        
        <div class="status" id="status"></div>
    </div>

    <script>
        let selectedRange = null;
        let chart = null;
        let chartData = null;
        
        Office.onReady((info) => {
            if (info.host === Office.HostType.Excel) {
                console.log('Excel æ•°æ®åˆ†æé¢æ¿å·²åŠ è½½');
                
                document.getElementById('selectRangeBtn').addEventListener('click', selectDataRange);
                document.getElementById('analyzeBtn').addEventListener('click', analyzeData);
                document.getElementById('insertChartBtn').addEventListener('click', insertChartToExcel);
            }
        });
        
        function selectDataRange() {
            Excel.run(async (context) => {
                try {
                    const range = context.workbook.getSelectedRange();
                    range.load("address");
                    await context.sync();
                    
                    selectedRange = range.address;
                    document.getElementById('rangeInfo').textContent = `å·²é€‰æ‹©: ${selectedRange}`;
                    document.getElementById('analyzeBtn').disabled = false;
                    
                    showStatus('âœ… æ•°æ®èŒƒå›´å·²é€‰æ‹©', 'success');
                } catch (error) {
                    showStatus('âŒ é€‰æ‹©èŒƒå›´å¤±è´¥: ' + error.message, 'error');
                }
            });
        }
        
        async function analyzeData() {
            if (!selectedRange) {
                showStatus('âŒ è¯·å…ˆé€‰æ‹©æ•°æ®èŒƒå›´', 'error');
                return;
            }
            
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            showStatus('æ­£åœ¨åˆ†ææ•°æ®...', 'success');
            
            try {
                await Excel.run(async (context) => {
                    const sheet = context.workbook.worksheets.getActiveWorksheet();
                    const range = sheet.getRange(selectedRange);
                    
                    // åŠ è½½æ•°æ®
                    range.load("values, rowCount, columnCount");
                    await context.sync();
                    
                    const values = range.values;
                    const rowCount = range.rowCount;
                    const colCount = range.columnCount;
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    document.getElementById('rowCount').textContent = rowCount;
                    document.getElementById('colCount').textContent = colCount;
                    
                    // è®¡ç®—æ•°å€¼ç»Ÿè®¡
                    let sum = 0;
                    let numCount = 0;
                    const numericValues = [];
                    
                    for (let i = 0; i < values.length; i++) {
                        for (let j = 0; j < values[i].length; j++) {
                            const val = values[i][j];
                            if (typeof val === 'number') {
                                sum += val;
                                numCount++;
                                numericValues.push(val);
                            }
                        }
                    }
                    
                    const avg = numCount > 0 ? (sum / numCount).toFixed(2) : 0;
                    document.getElementById('sumValue').textContent = sum.toFixed(2);
                    document.getElementById('avgValue').textContent = avg;
                    
                    // ç”Ÿæˆå›¾è¡¨æ•°æ®
                    generateChart(values, numericValues);
                    
                    // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                    showDataPreview(values);
                    
                    chartData = { values, numericValues, rowCount, colCount };
                    
                    document.getElementById('insertChartBtn').disabled = false;
                    showStatus('âœ… æ•°æ®åˆ†æå®Œæˆï¼', 'success');
                });
            } catch (error) {
                showStatus('âŒ åˆ†æå¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        function generateChart(values, numericValues) {
            const ctx = document.getElementById('dataChart').getContext('2d');
            
            // é”€æ¯æ—§å›¾è¡¨
            if (chart) {
                chart.destroy();
            }
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            let labels = [];
            let data = [];
            
            // å¦‚æœæœ‰æ•°å€¼æ•°æ®ï¼Œåˆ›å»ºæŸ±çŠ¶å›¾
            if (numericValues.length > 0) {
                // å–å‰20ä¸ªæ•°å€¼ç‚¹
                const sampleSize = Math.min(20, numericValues.length);
                const step = Math.floor(numericValues.length / sampleSize);
                
                for (let i = 0; i < sampleSize; i++) {
                    labels.push(`æ•°æ®ç‚¹ ${i + 1}`);
                    data.push(numericValues[i * step] || 0);
                }
            } else {
                // å¦‚æœæ²¡æœ‰æ•°å€¼ï¼Œä½¿ç”¨è¡Œæ•°ä½œä¸ºç¤ºä¾‹
                const rowCount = Math.min(10, values.length);
                for (let i = 0; i < rowCount; i++) {
                    labels.push(`è¡Œ ${i + 1}`);
                    data.push(i + 1);
                }
            }
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ•°æ®å€¼',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'æ•°æ®åˆ†å¸ƒå›¾'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function showDataPreview(values) {
            const preview = document.getElementById('dataPreview');
            const maxRows = Math.min(10, values.length);
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            for (let i = 0; i < maxRows; i++) {
                html += '<tr>';
                for (let j = 0; j < Math.min(5, values[i].length); j++) {
                    html += `<td style="padding: 4px; border: 1px solid #ddd;">${values[i][j] || ''}</td>`;
                }
                html += '</tr>';
            }
            html += '</table>';
            if (values.length > maxRows) {
                html += `<div style="margin-top: 5px; color: #666;">... è¿˜æœ‰ ${values.length - maxRows} è¡Œæ•°æ®</div>`;
            }
            
            preview.innerHTML = html;
        }
        
        async function insertChartToExcel() {
            if (!chartData) {
                showStatus('âŒ è¯·å…ˆåˆ†ææ•°æ®', 'error');
                return;
            }
            
            const btn = document.getElementById('insertChartBtn');
            btn.disabled = true;
            showStatus('æ­£åœ¨æ’å…¥å›¾è¡¨...', 'success');
            
            try {
                await Excel.run(async (context) => {
                    const sheet = context.workbook.worksheets.getActiveWorksheet();
                    
                    // åˆ›å»ºå›¾è¡¨
                    const chart = sheet.charts.add(
                        Excel.ChartType.columnClustered,
                        sheet.getRange(selectedRange),
                        Excel.ChartSeriesBy.auto
                    );
                    
                    chart.title.text = "æ•°æ®åˆ†æå›¾è¡¨";
                    chart.legend.position = Excel.ChartLegendPosition.bottom;
                    chart.dataLabels.showValue = true;
                    
                    // è®¾ç½®å›¾è¡¨ä½ç½®ï¼ˆåœ¨æ•°æ®å³ä¾§ï¼‰
                    const range = sheet.getRange(selectedRange);
                    range.load("columnIndex, columnCount");
                    await context.sync();
                    
                    chart.left = 400;
                    chart.top = 50;
                    chart.width = 400;
                    chart.height = 300;
                    
                    await context.sync();
                    showStatus('âœ… å›¾è¡¨å·²æˆåŠŸæ’å…¥åˆ° Excelï¼', 'success');
                });
            } catch (error) {
                showStatus('âŒ æ’å…¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
    </script>
</body>
</html>
