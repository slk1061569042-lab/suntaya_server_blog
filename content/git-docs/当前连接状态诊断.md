# Cursor 远程连接当前状态诊断

**生成时间**: 2026-01-07  
**诊断目的**: 确认远程 Cursor Server 端口，分析端口转发失败原因

---

## 📊 一、基础配置信息

### 1.1 SSH 连接配置

| 配置项 | 值 | 状态 |
|--------|-----|------|
| **SSH Host 别名** | `myserver` | ✅ 已配置 |
| **服务器 IP** | `115.190.54.220` | ✅ 已配置 |
| **SSH 端口** | `22` | ✅ 已配置 |
| **SSH 用户名** | `root` | ✅ 已配置 |
| **SSH 密钥路径** | `~/.ssh/id_rsa` | ✅ 已配置 |
| **SSH 配置文件位置** | `C:\Users\Administrator\.ssh\config` | ✅ 已配置 |

**SSH 配置详情**:
```ssh_config
Host myserver
    HostName 115.190.54.220
    User root
    Port 22
    IdentityFile ~/.ssh/id_rsa
    ServerAliveInterval 60
    ServerAliveCountMax 3
    StrictHostKeyChecking no
    UserKnownHostsFile ~/.ssh/known_hosts
```

### 1.2 端口转发配置

| 配置项 | 值 | 状态 | 说明 |
|--------|-----|------|------|
| **本地监听端口** | `11528` | ⚠️ 待验证 | Cursor 客户端通过此端口连接 |
| **SSH 端口转发类型** | 本地端口转发 (Local Port Forwarding) | ✅ 已启用 | `-L 11528:127.0.0.1:<remote_port>` |
| **远程目标地址** | `127.0.0.1:<remote_port>` | ❓ 待确认 | 需要确认 `<remote_port>` 的具体值 |
| **远程 Cursor Server 端口** | `<remote_port>` (待确认) | ❌ **未监听** | **这是当前问题的核心** |

---

## 🔍 二、连接链路分析

### 2.1 完整连接链路

```
本地 Cursor 客户端
    ↓ (连接)
本地端口 11528 (本地 SSH 客户端监听)
    ↓ (SSH 隧道)
SSH 连接 (本地 → 远程 115.190.54.220:22)
    ↓ (端口转发)
远程 sshd 进程
    ↓ (连接)
远程 127.0.0.1:<remote_port> (Cursor Server 应该监听这里)
    ↓
远程 Cursor Server 进程
```

### 2.2 端口转发机制说明

**SSH 本地端口转发的工作原理**:
- **本地端**: SSH 客户端在本地监听 `11528` 端口
- **SSH 隧道**: 通过 SSH 连接建立加密隧道
- **远程端**: SSH 服务器 (`sshd`) 收到转发请求后，尝试连接远程 `127.0.0.1:<remote_port>`
- **问题点**: 如果远程 `<remote_port>` 没有服务监听，SSH 转发会失败，导致本地 `11528` 连接被拒绝

**关键理解**:
- ✅ 端口转发逻辑在**本地机器**上运行（SSH 客户端进程）
- ✅ 远程只需要 `sshd` 正常运行，并允许端口转发
- ❌ **远程 Cursor Server 必须监听 `127.0.0.1:<remote_port>`**，否则转发失败

---

## ⚠️ 三、当前问题状态

### 3.1 问题描述

**核心问题**: 远程 Cursor Server 没有监听端口，导致 SSH 端口转发失败

**错误现象**:
- 本地 Cursor 尝试连接 `127.0.0.1:11528` 时失败
- 错误信息可能为: `Connection refused` 或 `ERR_CONNECTION_REFUSED`
- SSH 隧道可能已建立，但转发到远程端口时失败

### 3.2 需要确认的信息

#### ✅ 已确认
- SSH 基本连接正常（可以通过 `ssh myserver` 登录）
- SSH 端口转发功能已启用（`AllowTcpForwarding = yes`）
- 本地端口 `11528` 是 Cursor 使用的标准端口

#### ❓ 待确认（关键）
1. **远程 Cursor Server 应该监听的端口号是多少？**
   - 需要从以下来源确认：
     - Cursor 配置文件（如果有）
     - Cursor Server 进程启动参数（`--port` 参数）
     - Cursor Server 日志文件
     - 之前成功连接时的端口记录

2. **远程 Cursor Server 当前是否在运行？**
   - 检查命令: `ssh myserver "ps aux | grep cursor-server | grep -v grep"`
   - 如果进程存在，检查是否监听端口

3. **远程 Cursor Server 是否监听在正确的端口？**
   - 检查命令: `ssh myserver "ss -tlnp | grep cursor"`
   - 或者: `ssh myserver "netstat -tlnp | grep cursor"`

---

## 🔧 四、诊断命令清单

### 4.1 本地检查命令

**检查本地端口 11528 是否被监听**:
```powershell
# PowerShell
netstat -an | Select-String "11528" | Select-String "LISTENING"
```

**检查本地 SSH 连接状态**:
```powershell
# PowerShell
netstat -an | Select-String "115.190.54.220:22"
```

### 4.2 远程检查命令（在云服务器上执行）

**检查 Cursor Server 进程**:
```bash
ssh myserver "ps aux | grep cursor-server | grep -v grep"
```

**检查 Cursor Server 监听的端口**:
```bash
ssh myserver "ss -tlnp | grep cursor"
# 或者
ssh myserver "netstat -tlnp | grep cursor"
```

**检查所有 40000-50000 范围的端口（Cursor 常用范围）**:
```bash
ssh myserver "ss -tlnp | grep -E ':(4[0-9]{4}|5[0-9]{4}) '"
```

**检查 Cursor Server 进程启动参数（可能包含端口信息）**:
```bash
ssh myserver "ps aux | grep cursor-server | grep -v grep | head -1"
```

**检查 Cursor Server 令牌文件（用于验证服务是否正常初始化）**:
```bash
ssh myserver "ls -1 /run/user/0/cursor-remote-code.token.* 2>/dev/null | wc -l"
```

**检查系统资源（文件描述符限制，可能影响端口绑定）**:
```bash
ssh myserver "ulimit -n"
```

### 4.3 完整诊断脚本（在远程服务器上执行）

```bash
ssh myserver "
  echo '=== Cursor Server 诊断 ==='
  echo ''
  
  echo '1. 进程检查:'
  PROCESS_COUNT=\$(pgrep -f cursor-server | wc -l)
  echo \"   进程数量: \$PROCESS_COUNT\"
  if [ \$PROCESS_COUNT -gt 0 ]; then
    ps aux | grep cursor-server | grep -v grep | head -3
  fi
  echo ''
  
  echo '2. 端口监听检查:'
  PORT_COUNT=\$(ss -tlnp | grep cursor | wc -l)
  echo \"   监听端口数量: \$PORT_COUNT\"
  if [ \$PORT_COUNT -gt 0 ]; then
    ss -tlnp | grep cursor
  else
    echo '   ⚠️  未发现监听端口'
  fi
  echo ''
  
  echo '3. 令牌文件检查:'
  TOKEN_COUNT=\$(ls -1 /run/user/0/cursor-remote-code.token.* 2>/dev/null | wc -l)
  echo \"   令牌文件数量: \$TOKEN_COUNT\"
  echo ''
  
  echo '4. 进程启动参数（查找端口信息）:'
  if [ \$PROCESS_COUNT -gt 0 ]; then
    ps aux | grep cursor-server | grep -v grep | head -1 | awk '{for(i=11;i<=NF;i++) printf \"%s \", \$i; print \"\"}'
  fi
  echo ''
  
  echo '5. 诊断结论:'
  if [ \$PROCESS_COUNT -eq 0 ]; then
    echo '   ❌ Cursor Server 进程不存在'
  elif [ \$PORT_COUNT -eq 0 ]; then
    echo '   ⚠️  进程存在但未监听端口（端口绑定失败）'
  elif [ \$TOKEN_COUNT -eq 0 ]; then
    echo '   ⚠️  进程存在但无令牌文件（初始化未完成）'
  else
    echo '   ✅ 进程状态正常'
  fi
"
```

---

## 📋 五、状态总结表

| 检查项 | 状态 | 说明 |
|--------|------|------|
| **SSH 基本连接** | ✅ 正常 | 可以通过 `ssh myserver` 登录 |
| **SSH 端口转发配置** | ✅ 已启用 | `AllowTcpForwarding = yes` |
| **本地端口 11528** | ❓ 待检查 | 需要确认是否被 SSH 客户端监听 |
| **远程 Cursor Server 进程** | ❓ 待检查 | 需要确认进程是否存在 |
| **远程 Cursor Server 端口** | ❌ **未监听** | **这是问题的核心** |
| **远程端口号** | ❓ 待确认 | 需要确认具体端口号 |

---

## 🎯 六、下一步行动

### 步骤 1: 确认远程 Cursor Server 端口号

**方法 A: 从进程启动参数中提取**
```bash
ssh myserver "ps aux | grep cursor-server | grep -v grep | head -1"
```
查找输出中的 `--port <数字>` 或 `:<4-5位数字>` 模式

**方法 B: 检查 Cursor Server 日志**
```bash
ssh myserver "find /run/user/0 -name 'cursor-remote-code.log.*' -type f 2>/dev/null | head -1 | xargs tail -50"
```

**方法 C: 检查 Cursor Server 配置文件**
```bash
ssh myserver "find ~/.cursor-server -name '*.json' -o -name '*.conf' 2>/dev/null | head -5"
```

### 步骤 2: 验证远程端口是否监听

一旦确认了端口号（假设为 `<remote_port>`），执行：
```bash
ssh myserver "ss -tlnp | grep ':<remote_port> '"
```

### 步骤 3: 如果端口未监听，分析原因

可能的原因：
1. **Cursor Server 进程未启动** → 需要重新连接触发启动
2. **Cursor Server 进程启动失败** → 检查日志和系统资源
3. **端口被其他进程占用** → 检查端口占用情况
4. **文件描述符限制** → 检查 `ulimit -n`
5. **权限问题** → 检查进程运行用户和目录权限

---

## 🔬 七、错误分析与链路排查

### 7.1 常见错误类型及含义

#### 错误类型 A: `Connection refused` / `ERR_CONNECTION_REFUSED`

**含义**: 连接被拒绝，目标端口没有服务监听

**可能发生的位置**:
1. **本地 `127.0.0.1:11528`** → 说明本地 SSH 客户端没有监听 11528
2. **远程 `127.0.0.1:<remote_port>`** → 说明远程 Cursor Server 没有监听端口（**当前问题**）

**排查方法**:
```bash
# 检查本地端口
netstat -an | Select-String "11528" | Select-String "LISTENING"

# 检查远程端口（需要先确认端口号）
ssh myserver "ss -tlnp | grep ':<remote_port> '"
```

#### 错误类型 B: `Connection timed out`

**含义**: 连接超时，网络不通或防火墙阻止

**可能发生的位置**:
1. **本地 → 远程 SSH (22端口)** → 网络不通或安全组未开放
2. **SSH 隧道内部** → 隧道建立但转发失败

**排查方法**:
```bash
# 测试 SSH 连接
ssh -v myserver "echo 'test'"

# 检查防火墙
ssh myserver "sudo ufw status"
```

#### 错误类型 C: `WebSocket close with status code 1006`

**含义**: WebSocket 连接异常关闭（非正常关闭）

**可能原因**:
- SSH 隧道中断
- 远程 Cursor Server 进程崩溃
- 网络波动导致连接丢失

**排查方法**:
```bash
# 检查 Cursor Server 进程状态
ssh myserver "ps aux | grep cursor-server | grep -v grep"

# 检查 SSH 连接稳定性
ssh -v myserver "echo 'test'" 2>&1 | grep -i forwarding
```

### 7.2 逐段链路排查方法

#### 段 1: 本地 Cursor → 本地端口 11528

**检查命令**:
```powershell
# PowerShell
netstat -an | Select-String "11528"
```

**正常状态**: 应该看到 `LISTENING` 状态

**异常处理**:
- 如果没有 `LISTENING`，说明 SSH 端口转发未建立
- 需要检查 Cursor 是否正在尝试连接，或手动建立 SSH 隧道

#### 段 2: 本地端口 11528 → SSH 隧道

**检查命令**:
```powershell
# PowerShell - 检查 SSH 连接
netstat -an | Select-String "115.190.54.220:22"
```

**正常状态**: 应该看到 `ESTABLISHED` 状态的 SSH 连接

**异常处理**:
- 如果没有连接，说明 SSH 隧道未建立
- 需要检查 SSH 配置和网络连接

#### 段 3: SSH 隧道 → 远程 sshd

**检查命令**:
```bash
# 在远程服务器上检查 SSH 连接
ssh myserver "ss -tn | grep ':22 ' | grep ESTAB"
```

**正常状态**: 应该看到来自你本地 IP 的 SSH 连接

**异常处理**:
- 如果看不到连接，说明 SSH 连接未建立
- 检查 SSH 服务状态: `ssh myserver "sudo systemctl status sshd"`

#### 段 4: 远程 sshd → 远程 Cursor Server 端口

**检查命令**:
```bash
# 这是关键检查点
ssh myserver "ss -tlnp | grep cursor"
```

**正常状态**: 应该看到类似这样的输出:
```
LISTEN 0 128 127.0.0.1:40305 0.0.0.0:* users:(("cursor-server",pid=1234,fd=7))
```

**异常处理**:
- **如果没有输出** → **这就是当前问题**：Cursor Server 没有监听端口
- 需要检查进程状态、日志、系统资源等

### 7.3 端口未监听的常见原因分析

#### 原因 1: Cursor Server 进程未启动

**现象**:
- `ps aux | grep cursor-server` 没有输出
- 没有监听端口

**解决方法**:
- 在 Cursor 中重新连接，触发 Cursor Server 自动下载和启动
- 或手动启动（如果知道启动命令）

#### 原因 2: 进程存在但端口绑定失败

**现象**:
- `ps aux | grep cursor-server` 有输出
- `ss -tlnp | grep cursor` 没有输出

**可能原因**:
1. **端口被占用**: 另一个进程占用了目标端口
2. **文件描述符限制**: `ulimit -n` 太小
3. **权限问题**: 进程没有权限绑定端口
4. **进程卡死**: 进程处于异常状态（Zombie/Hanging）

**排查方法**:
```bash
# 检查端口占用
ssh myserver "ss -tlnp | grep -E ':(4[0-9]{4}|5[0-9]{4}) '"

# 检查文件描述符限制
ssh myserver "ulimit -n"

# 检查进程状态
ssh myserver "ps aux | grep cursor-server | grep -v grep"

# 检查进程是否响应
ssh myserver "kill -0 \$(pgrep -f cursor-server | head -1) && echo '进程响应' || echo '进程无响应'"
```

#### 原因 3: 进程监听在错误的 IP/端口

**现象**:
- 进程存在
- 有端口监听，但不在 `127.0.0.1` 上，或在错误的端口

**排查方法**:
```bash
# 检查所有监听端口
ssh myserver "ss -tlnp | grep cursor"

# 检查进程启动参数（可能包含端口信息）
ssh myserver "ps aux | grep cursor-server | grep -v grep | head -1"
```

---

## 📚 八、完整排查流程图

### 8.1 排查流程图

```
开始排查
    ↓
[1] 检查本地端口 11528 是否监听
    ├─ 是 → [2]
    └─ 否 → ❌ SSH 端口转发未建立 → 检查 Cursor 连接状态
            ↓
[2] 检查 SSH 连接是否建立
    ├─ 是 → [3]
    └─ 否 → ❌ SSH 连接失败 → 检查网络和 SSH 配置
            ↓
[3] 检查远程 Cursor Server 进程
    ├─ 存在 → [4]
    └─ 不存在 → ❌ 进程未启动 → 重新连接触发启动
            ↓
[4] 检查远程 Cursor Server 端口监听
    ├─ 有监听 → ✅ 正常 → 检查端口号是否匹配
    └─ 无监听 → ❌ **当前问题** → [5]
            ↓
[5] 分析端口未监听的原因
    ├─ 端口被占用 → 检查端口占用情况
    ├─ 文件描述符限制 → 检查 ulimit
    ├─ 权限问题 → 检查进程用户和权限
    └─ 进程异常 → 强制停止并重启
```

### 8.2 快速诊断脚本（一键执行）

**在 PowerShell 中执行**:
```powershell
Write-Host "=== Cursor 连接完整诊断 ===" -ForegroundColor Cyan
Write-Host ""

# 1. 检查本地端口
Write-Host "[1] 检查本地端口 11528..." -ForegroundColor Yellow
$localPort = netstat -an | Select-String "11528" | Select-String "LISTENING"
if ($localPort) {
    Write-Host "   ✅ 本地端口 11528 正在监听" -ForegroundColor Green
} else {
    Write-Host "   ❌ 本地端口 11528 未监听" -ForegroundColor Red
}
Write-Host ""

# 2. 检查 SSH 连接
Write-Host "[2] 检查 SSH 连接..." -ForegroundColor Yellow
$sshConn = netstat -an | Select-String "115.190.54.220:22" | Select-String "ESTABLISHED"
if ($sshConn) {
    Write-Host "   ✅ SSH 连接已建立" -ForegroundColor Green
} else {
    Write-Host "   ❌ SSH 连接未建立" -ForegroundColor Red
}
Write-Host ""

# 3. 检查远程进程
Write-Host "[3] 检查远程 Cursor Server 进程..." -ForegroundColor Yellow
$processCheck = ssh myserver "pgrep -f cursor-server | wc -l" 2>&1
$processCount = [int]($processCheck -replace '\D','')
if ($processCount -gt 0) {
    Write-Host "   ✅ 发现 $processCount 个进程" -ForegroundColor Green
    ssh myserver "ps aux | grep cursor-server | grep -v grep | head -2" 2>&1 | ForEach-Object { Write-Host "   $_" -ForegroundColor Gray }
} else {
    Write-Host "   ❌ 未发现进程" -ForegroundColor Red
}
Write-Host ""

# 4. 检查远程端口
Write-Host "[4] 检查远程端口监听..." -ForegroundColor Yellow
$portCheck = ssh myserver "ss -tlnp | grep cursor" 2>&1
if ($portCheck -and $portCheck.Trim() -ne "") {
    Write-Host "   ✅ 发现监听端口:" -ForegroundColor Green
    $portCheck | ForEach-Object { Write-Host "   $_" -ForegroundColor Gray }
} else {
    Write-Host "   ❌ 未发现监听端口（这是问题所在）" -ForegroundColor Red
}
Write-Host ""

# 5. 诊断结论
Write-Host "[5] 诊断结论:" -ForegroundColor Yellow
if ($localPort -and $sshConn -and $processCount -gt 0 -and $portCheck) {
    Write-Host "   ✅ 所有检查项正常" -ForegroundColor Green
} elseif (-not $portCheck -and $processCount -gt 0) {
    Write-Host "   ⚠️  进程存在但未监听端口（端口绑定失败）" -ForegroundColor Yellow
    Write-Host "   建议: 强制停止进程并重新连接" -ForegroundColor Cyan
} elseif ($processCount -eq 0) {
    Write-Host "   ⚠️  Cursor Server 进程不存在" -ForegroundColor Yellow
    Write-Host "   建议: 在 Cursor 中重新连接" -ForegroundColor Cyan
} else {
    Write-Host "   ❌ 连接链路存在问题，请逐段排查" -ForegroundColor Red
}
```

---

## 📝 九、备注

1. **端口转发位置**: SSH 端口转发逻辑在**本地机器**上运行，远程只需要 `sshd` 正常运行
2. **远程端口**: Cursor Server 通常监听在 `127.0.0.1`（本地回环），端口号可能是动态分配的（40000-50000 范围）
3. **问题根源**: 当前问题的核心是**远程 Cursor Server 没有监听端口**，导致 SSH 转发失败
4. **排查顺序**: 先确认端口号 → 再检查是否监听 → 最后分析为什么没监听
5. **错误定位**: 根据错误信息类型（Connection refused / Connection timed out / WebSocket 1006）可以快速定位问题段

---

## 🎯 十、下一步行动清单

- [ ] 执行完整诊断脚本，获取当前状态
- [ ] 确认远程 Cursor Server 端口号（从进程参数或日志中提取）
- [ ] 验证远程端口是否监听
- [ ] 如果未监听，分析具体原因（端口占用/资源限制/权限问题）
- [ ] 根据分析结果采取相应修复措施
- [ ] 重新测试连接

---

**最后更新**: 2026-01-07  
**文档状态**: 已完成基础状态记录、错误分析和完整排查步骤

