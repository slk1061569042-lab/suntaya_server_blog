---
name: devrules
description: Next.js 开发规范 - 确保代码可以成功构建
---

# Next.js 开发规范

## 🎯 核心原则

**所有代码必须能够成功构建（`npm run build`），而不仅仅是能够运行（`npm run dev`）。**

## ⚠️ 为什么会出现 "能运行但不能构建" 的问题？

### 1. **开发模式 vs 生产构建的区别**

- **开发模式 (`npm run dev`)**:
  - 使用 Turbopack 快速编译
  - 类型检查较宽松，允许部分类型错误
  - 热更新，错误不会阻止运行
  - 主要用于快速开发和调试

- **生产构建 (`npm run build`)**:
  - 严格的 TypeScript 类型检查
  - 完整的代码优化和压缩
  - 任何类型错误都会导致构建失败
  - 必须通过所有检查才能成功构建

### 2. **常见问题**

- ❌ TypeScript 类型错误（类型不匹配、未定义的类型等）
- ❌ 未使用的导入或变量
- ❌ 缺少必要的类型定义
- ❌ 类型定义与实际使用不一致
- ❌ 语法错误（在开发模式下可能被忽略）

## ✅ 开发规范

### 1. **必须通过类型检查**

在提交代码前，必须运行类型检查：

```bash
npm run type-check
```

或者直接运行构建：

```bash
npm run build
```

### 2. **禁止的行为**

❌ **禁止**编写只能在开发模式下运行的代码
❌ **禁止**忽略 TypeScript 类型错误
❌ **禁止**使用 `@ts-ignore` 或 `@ts-expect-error` 来绕过类型检查（除非有充分理由）
❌ **禁止**提交无法构建的代码

### 3. **必须的行为**

✅ **必须**在开发过程中定期运行 `npm run build` 验证代码
✅ **必须**修复所有 TypeScript 类型错误
✅ **必须**确保类型定义完整且正确
✅ **必须**在提交前确保构建成功

### 4. **类型检查脚本**

项目已配置以下脚本：

- `npm run type-check`: 运行 TypeScript 类型检查（不生成文件）
- `npm run build`: 构建生产版本（会自动运行类型检查）
- `prebuild`: 在构建前自动运行类型检查

### 5. **开发工作流**

推荐的工作流程：

1. **开发时**:
   ```bash
   npm run dev  # 快速开发
   ```

2. **提交前**:
   ```bash
   npm run type-check  # 检查类型
   npm run build       # 验证构建
   ```

3. **部署前**:
   ```bash
   npm run build  # 确保构建成功
   ```

## 🔧 类型检查工具

### 使用 TypeScript 编译器

```bash
# 检查所有类型错误（不生成文件）
npx tsc --noEmit

# 或者使用项目脚本
npm run type-check
```

### 在 IDE 中

- VS Code / Cursor: TypeScript 错误会实时显示
- 确保 TypeScript 版本与项目一致
- 定期重启 TypeScript 服务器（`Ctrl+Shift+P` → "TypeScript: Restart TS Server"）

## 📋 检查清单

在提交代码前，确保：

- [ ] `npm run type-check` 通过
- [ ] `npm run build` 成功
- [ ] 没有 TypeScript 类型错误
- [ ] 没有未使用的导入
- [ ] 所有类型定义正确
- [ ] 代码符合项目规范

## 🚨 常见错误及解决方案

### 错误 1: 类型不匹配

```typescript
// ❌ 错误
const value: string = 123;

// ✅ 正确
const value: string = "123";
```

### 错误 2: 未定义的类型

```typescript
// ❌ 错误
type Operation = 'add' | 'commit';
// 但在 switch 中使用了 'push'
case 'push': // 类型错误

// ✅ 正确
type Operation = 'add' | 'commit' | 'push';
case 'push': // 类型正确
```

### 错误 3: 缺少类型定义

```typescript
// ❌ 错误
function handleAction(action) { // action 没有类型

// ✅ 正确
function handleAction(action: Operation) {
```

## 💡 最佳实践

1. **类型优先**: 先定义类型，再编写代码
2. **严格模式**: 保持 `tsconfig.json` 中的 `strict: true`
3. **定期检查**: 开发过程中定期运行类型检查
4. **及时修复**: 发现类型错误立即修复，不要积累
5. **代码审查**: 提交前自我审查，确保类型正确

## 📚 相关资源

- TypeScript 官方文档: https://www.typescriptlang.org/docs/
- Next.js 类型检查: https://nextjs.org/docs/app/building-your-application/configuring/typescript
- 项目 TypeScript 配置: `tsconfig.json`

---

**记住**: 如果代码不能构建，就不能部署。始终确保代码可以通过 `npm run build`！
