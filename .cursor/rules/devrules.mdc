---
name: devrules
description: Next.js å¼€å‘è§„èŒƒ - ç¡®ä¿ä»£ç å¯ä»¥æˆåŠŸæ„å»º
---

# Next.js å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰ä»£ç å¿…é¡»èƒ½å¤ŸæˆåŠŸæ„å»ºï¼ˆ`npm run build`ï¼‰ï¼Œè€Œä¸ä»…ä»…æ˜¯èƒ½å¤Ÿè¿è¡Œï¼ˆ`npm run dev`ï¼‰ã€‚**

## âš ï¸ ä¸ºä»€ä¹ˆä¼šå‡ºç° "èƒ½è¿è¡Œä½†ä¸èƒ½æ„å»º" çš„é—®é¢˜ï¼Ÿ

### 1. **å¼€å‘æ¨¡å¼ vs ç”Ÿäº§æ„å»ºçš„åŒºåˆ«**

- **å¼€å‘æ¨¡å¼ (`npm run dev`)**:
  - ä½¿ç”¨ Turbopack å¿«é€Ÿç¼–è¯‘
  - ç±»å‹æ£€æŸ¥è¾ƒå®½æ¾ï¼Œå…è®¸éƒ¨åˆ†ç±»å‹é”™è¯¯
  - çƒ­æ›´æ–°ï¼Œé”™è¯¯ä¸ä¼šé˜»æ­¢è¿è¡Œ
  - ä¸»è¦ç”¨äºå¿«é€Ÿå¼€å‘å’Œè°ƒè¯•

- **ç”Ÿäº§æ„å»º (`npm run build`)**:
  - ä¸¥æ ¼çš„ TypeScript ç±»å‹æ£€æŸ¥
  - å®Œæ•´çš„ä»£ç ä¼˜åŒ–å’Œå‹ç¼©
  - ä»»ä½•ç±»å‹é”™è¯¯éƒ½ä¼šå¯¼è‡´æ„å»ºå¤±è´¥
  - å¿…é¡»é€šè¿‡æ‰€æœ‰æ£€æŸ¥æ‰èƒ½æˆåŠŸæ„å»º

### 2. **å¸¸è§é—®é¢˜**

- âŒ TypeScript ç±»å‹é”™è¯¯ï¼ˆç±»å‹ä¸åŒ¹é…ã€æœªå®šä¹‰çš„ç±»å‹ç­‰ï¼‰
- âŒ æœªä½¿ç”¨çš„å¯¼å…¥æˆ–å˜é‡
- âŒ ç¼ºå°‘å¿…è¦çš„ç±»å‹å®šä¹‰
- âŒ ç±»å‹å®šä¹‰ä¸å®é™…ä½¿ç”¨ä¸ä¸€è‡´
- âŒ è¯­æ³•é”™è¯¯ï¼ˆåœ¨å¼€å‘æ¨¡å¼ä¸‹å¯èƒ½è¢«å¿½ç•¥ï¼‰

## âœ… å¼€å‘è§„èŒƒ

### 1. **å¿…é¡»é€šè¿‡ç±»å‹æ£€æŸ¥**

åœ¨æäº¤ä»£ç å‰ï¼Œå¿…é¡»è¿è¡Œç±»å‹æ£€æŸ¥ï¼š

```bash
npm run type-check
```

æˆ–è€…ç›´æ¥è¿è¡Œæ„å»ºï¼š

```bash
npm run build
```

### 2. **ç¦æ­¢çš„è¡Œä¸º**

âŒ **ç¦æ­¢**ç¼–å†™åªèƒ½åœ¨å¼€å‘æ¨¡å¼ä¸‹è¿è¡Œçš„ä»£ç 
âŒ **ç¦æ­¢**å¿½ç•¥ TypeScript ç±»å‹é”™è¯¯
âŒ **ç¦æ­¢**ä½¿ç”¨ `@ts-ignore` æˆ– `@ts-expect-error` æ¥ç»•è¿‡ç±»å‹æ£€æŸ¥ï¼ˆé™¤éæœ‰å……åˆ†ç†ç”±ï¼‰
âŒ **ç¦æ­¢**æäº¤æ— æ³•æ„å»ºçš„ä»£ç 

### 3. **å¿…é¡»çš„è¡Œä¸º**

âœ… **å¿…é¡»**åœ¨å¼€å‘è¿‡ç¨‹ä¸­å®šæœŸè¿è¡Œ `npm run build` éªŒè¯ä»£ç 
âœ… **å¿…é¡»**ä¿®å¤æ‰€æœ‰ TypeScript ç±»å‹é”™è¯¯
âœ… **å¿…é¡»**ç¡®ä¿ç±»å‹å®šä¹‰å®Œæ•´ä¸”æ­£ç¡®
âœ… **å¿…é¡»**åœ¨æäº¤å‰ç¡®ä¿æ„å»ºæˆåŠŸ

### 4. **ç±»å‹æ£€æŸ¥è„šæœ¬**

é¡¹ç›®å·²é…ç½®ä»¥ä¸‹è„šæœ¬ï¼š

- `npm run type-check`: è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥ï¼ˆä¸ç”Ÿæˆæ–‡ä»¶ï¼‰
- `npm run build`: æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆä¼šè‡ªåŠ¨è¿è¡Œç±»å‹æ£€æŸ¥ï¼‰
- `prebuild`: åœ¨æ„å»ºå‰è‡ªåŠ¨è¿è¡Œç±»å‹æ£€æŸ¥

### 5. **å¼€å‘å·¥ä½œæµ**

æ¨èçš„å·¥ä½œæµç¨‹ï¼š

1. **å¼€å‘æ—¶**:
   ```bash
   npm run dev  # å¿«é€Ÿå¼€å‘
   ```

2. **æäº¤å‰**:
   ```bash
   npm run type-check  # æ£€æŸ¥ç±»å‹
   npm run build       # éªŒè¯æ„å»º
   ```

3. **éƒ¨ç½²å‰**:
   ```bash
   npm run build  # ç¡®ä¿æ„å»ºæˆåŠŸ
   ```

## ğŸ”§ ç±»å‹æ£€æŸ¥å·¥å…·

### ä½¿ç”¨ TypeScript ç¼–è¯‘å™¨

```bash
# æ£€æŸ¥æ‰€æœ‰ç±»å‹é”™è¯¯ï¼ˆä¸ç”Ÿæˆæ–‡ä»¶ï¼‰
npx tsc --noEmit

# æˆ–è€…ä½¿ç”¨é¡¹ç›®è„šæœ¬
npm run type-check
```

### åœ¨ IDE ä¸­

- VS Code / Cursor: TypeScript é”™è¯¯ä¼šå®æ—¶æ˜¾ç¤º
- ç¡®ä¿ TypeScript ç‰ˆæœ¬ä¸é¡¹ç›®ä¸€è‡´
- å®šæœŸé‡å¯ TypeScript æœåŠ¡å™¨ï¼ˆ`Ctrl+Shift+P` â†’ "TypeScript: Restart TS Server"ï¼‰

## ğŸ“‹ æ£€æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œç¡®ä¿ï¼š

- [ ] `npm run type-check` é€šè¿‡
- [ ] `npm run build` æˆåŠŸ
- [ ] æ²¡æœ‰ TypeScript ç±»å‹é”™è¯¯
- [ ] æ²¡æœ‰æœªä½¿ç”¨çš„å¯¼å…¥
- [ ] æ‰€æœ‰ç±»å‹å®šä¹‰æ­£ç¡®
- [ ] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ

## ğŸš¨ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1: ç±»å‹ä¸åŒ¹é…

```typescript
// âŒ é”™è¯¯
const value: string = 123;

// âœ… æ­£ç¡®
const value: string = "123";
```

### é”™è¯¯ 2: æœªå®šä¹‰çš„ç±»å‹

```typescript
// âŒ é”™è¯¯
type Operation = 'add' | 'commit';
// ä½†åœ¨ switch ä¸­ä½¿ç”¨äº† 'push'
case 'push': // ç±»å‹é”™è¯¯

// âœ… æ­£ç¡®
type Operation = 'add' | 'commit' | 'push';
case 'push': // ç±»å‹æ­£ç¡®
```

### é”™è¯¯ 3: ç¼ºå°‘ç±»å‹å®šä¹‰

```typescript
// âŒ é”™è¯¯
function handleAction(action) { // action æ²¡æœ‰ç±»å‹

// âœ… æ­£ç¡®
function handleAction(action: Operation) {
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **ç±»å‹ä¼˜å…ˆ**: å…ˆå®šä¹‰ç±»å‹ï¼Œå†ç¼–å†™ä»£ç 
2. **ä¸¥æ ¼æ¨¡å¼**: ä¿æŒ `tsconfig.json` ä¸­çš„ `strict: true`
3. **å®šæœŸæ£€æŸ¥**: å¼€å‘è¿‡ç¨‹ä¸­å®šæœŸè¿è¡Œç±»å‹æ£€æŸ¥
4. **åŠæ—¶ä¿®å¤**: å‘ç°ç±»å‹é”™è¯¯ç«‹å³ä¿®å¤ï¼Œä¸è¦ç§¯ç´¯
5. **ä»£ç å®¡æŸ¥**: æäº¤å‰è‡ªæˆ‘å®¡æŸ¥ï¼Œç¡®ä¿ç±»å‹æ­£ç¡®

## ğŸ§¹ Lintï¼ˆESLintï¼‰è§„èŒƒ

### 1. å¿…é¡»é€šè¿‡ Lint æ£€æŸ¥

- æ‰€æœ‰è¦åˆå¹¶ / éƒ¨ç½²çš„ä»£ç ï¼Œ**å¿…é¡»é€šè¿‡**ï¼š

```bash
npm run lint
```

- ç¦æ­¢å¸¦æœ‰ **eslint error** çš„ä»£ç æäº¤åˆ°è¿œç«¯æˆ–åˆå¹¶åˆ°ä¸»åˆ†æ”¯ã€‚
- è‹¥å‡ºç° eslint æŠ¥é”™ï¼Œ**ä¼˜å…ˆä¿®æ”¹ä»£ç ** ä»¥æ»¡è¶³è§„åˆ™ï¼›ä»…åœ¨æœ‰æ˜ç¡®ç†ç”±æ—¶æ‰ä½¿ç”¨å±€éƒ¨ `eslint-disable`ã€‚

æ¨èå®Œæ•´æœ¬åœ°æ£€æŸ¥æµç¨‹ï¼š

```bash
npm run type-check
npm run lint
npm run build
```

### 2. React ç›¸å…³çº¦æŸ

#### 2.1 ä¸è¦åœ¨ `try/catch` ä¸­æ„é€  JSX æˆ–æ¸²æŸ“ç»„ä»¶

- âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆä¹‹å‰åœ¨ `app/docs/[slug]/page.tsx` ä¸­å‡ºç°è¿‡ï¼‰ï¼š

```tsx
try {
  const data = await loadData();
  return (
    <Page>
      <Sidebar />
      <Content data={data} />
    </Page>
  );
} catch (e) {
  console.error(e);
  return <div>error</div>;
}
```

- âœ… æ­£ç¡®ç¤ºä¾‹ï¼šåªåœ¨ `try/catch` é‡Œåšæ•°æ®åŠ è½½ï¼Œ**JSX æ”¾åœ¨å‡½æ•°æ­£å¸¸è¿”å›è·¯å¾„**ï¼Œæ¸²æŸ“é”™è¯¯äº¤ç»™ Error Boundaryï¼š

```tsx
const filePath = getMarkdownFile(doc.file);
let html: string;
let toc: TocItem[];

try {
  const result = await processMarkdown(filePath);
  html = result.html;
  toc = result.toc;
} catch (error) {
  console.error('Error loading document:', error);
  notFound(); // æˆ–å…¶ä»–è·³è½¬ / å…œåº•
}

return (
  <div className="min-h-screen flex">
    <Sidebar />
    {/* ... */}
    <TableOfContents items={toc} />
  </div>
);
```

> åŸåˆ™ï¼š**try/catch è´Ÿè´£â€œæ‹¿åˆ°æ•°æ®â€ï¼ŒJSX è´Ÿè´£â€œæ€ä¹ˆç”»â€**ï¼›æ¸²æŸ“å¼‚å¸¸ä½¿ç”¨ Error Boundaryï¼Œè€Œä¸æ˜¯ try/catchã€‚

#### 2.2 `useEffect` ä¸­ä¸è¦ç”¨äºå•çº¯çš„åŒæ­¥çŠ¶æ€è®¡ç®—

- å¯¹äº**ä»…ä¾èµ– props/state çš„åŒæ­¥è®¡ç®—**ï¼Œ**ä¼˜å…ˆä½¿ç”¨ï¼š**
  - ç›´æ¥åœ¨æ¸²æŸ“ä¸­è®¡ç®—ï¼Œæˆ–
  - äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ›´æ–°çŠ¶æ€ï¼Œ
  è€Œä¸æ˜¯å¥—ä¸€å±‚ `useEffect` å† `setState`ã€‚

- âŒ ä¹‹å‰çš„å†™æ³•ï¼ˆ`components/Search.tsx`ï¼‰ï¼š

```tsx
useEffect(() => {
  if (query.trim()) {
    const searchResults = searchDocs(query);
    setResults(searchResults.slice(0, 5));
    setIsOpen(true);
  } else {
    setResults([]);
    setIsOpen(false);
  }
}, [query]);
```

- âœ… æ”¹é€ åçš„æ¨èå†™æ³•ï¼šæŠŠé€»è¾‘æ”¾åˆ°äº‹ä»¶é‡Œï¼š

```tsx
onChange={(e) => {
  const value = e.target.value;
  setQuery(value);

  if (value.trim()) {
    const searchResults = searchDocs(value);
    setResults(searchResults.slice(0, 5));
    setIsOpen(true);
  } else {
    setResults([]);
    setIsOpen(false);
  }
}}
```

- å¦‚æœç¡®å®éœ€è¦åœ¨ `useEffect` ä¸­è¯»å–å¤–éƒ¨ç³»ç»Ÿå¹¶åŒæ­¥çŠ¶æ€ï¼ˆå¦‚ `matchMedia`ã€è®¢é˜…äº‹ä»¶ç­‰ï¼‰ï¼Œå¿…é¡»ï¼š
  - åªåœ¨ **åˆå§‹åŒ– / è®¢é˜…å›è°ƒä¸­** è°ƒç”¨ `setState`ï¼›
  - å¿…è¦æ—¶åœ¨å¯¹åº”è¡Œå¢åŠ æœ‰è¯´æ˜çš„ `// eslint-disable-next-line react-hooks/set-state-in-effect`ï¼Œå¹¶å†™æ¸…æ¥šåŸå› ã€‚

#### 2.3 ä¸è¦åœ¨ç»„ä»¶ render å†…å®šä¹‰å­ç»„ä»¶

- âŒ é”™è¯¯æ¨¡å¼ï¼ˆä¹‹å‰åœ¨ `GitFlowDiagram` ä¸­å‡ºç°è¿‡ï¼Œè§¦å‘ `react-hooks/static-components`ï¼‰ï¼š

```tsx
export default function Page() {
  const [state] = useState(...);

  const Item = ({ value }: { value: string }) => {
    return <div>{value}</div>;
  };

  return (
    <div>
      {list.map(v => (
        <Item key={v} value={v} />
      ))}
    </div>
  );
}
```

- é—®é¢˜ï¼š
  - æ¯æ¬¡ render éƒ½ä¼šé‡æ–°åˆ›å»º `Item` ç»„ä»¶ï¼Œå¯èƒ½å¯¼è‡´å­ç»„ä»¶çŠ¶æ€ä¸¢å¤±æˆ–æ€§èƒ½é—®é¢˜ã€‚
  - ä¼šè§¦å‘ eslint çš„ `react-hooks/static-components` æŠ¥é”™ã€‚

- âœ… è§„èŒƒå†™æ³•ï¼š**å­ç»„ä»¶å®šä¹‰åœ¨æ–‡ä»¶é¡¶å±‚**ï¼Œé€šè¿‡ props ä¼ å…¥æ‰€éœ€æ•°æ®ï¼š

```tsx
function Item({ value }: { value: string }) {
  return <div>{value}</div>;
}

export default function Page() {
  const [state] = useState(...);

  return (
    <div>
      {list.map(v => (
        <Item key={v} value={v} />
      ))}
    </div>
  );
}
```

- å¦‚å› å†å²åŸå› æš‚æ—¶æ— æ³•é‡æ„ï¼Œéœ€è¦åœ¨å±€éƒ¨ä½¿ç”¨ï¼š

```tsx
// eslint-disable-next-line react-hooks/static-components
const Item = (...) => { ... };
```

æ—¶ï¼Œ**å¿…é¡»åœ¨åŒä¸€è¡Œæˆ–ä¸Šæ–¹æ³¨é‡Šä¸­å†™æ˜åŸå› å’Œåç»­é‡æ„è®¡åˆ’**ï¼Œé¿å…ä»¥åç»§ç»­å¼•å…¥æ–°çš„å†…éƒ¨å®šä¹‰ç»„ä»¶ã€‚

### 3. Node è„šæœ¬ä¸ `require`

é¡¹ç›®å‰ç«¯ / TypeScript ä»£ç ç»Ÿä¸€ä½¿ç”¨ ES Module å¯¼å…¥ï¼š

- âœ… å‰ç«¯/TS æ–‡ä»¶ï¼š

```ts
import fs from 'fs';
```

- âŒ ç¦æ­¢åœ¨ `.ts` / `.tsx` / å‰ç«¯ä»£ç ä¸­ä½¿ç”¨ï¼š

```ts
const fs = require('fs');
```

é’ˆå¯¹ **çº¯ Node è„šæœ¬ï¼ˆä¾‹å¦‚ `scripts/generate-commit-msg.js`ï¼ŒGit hooks ç­‰å·¥å…·è„šæœ¬ï¼‰**ï¼š

- å¯ä»¥ç»§ç»­ä½¿ç”¨ `require`ï¼Œä½†å¿…é¡»åœ¨æ–‡ä»¶é¡¶éƒ¨ç»Ÿä¸€å£°æ˜ï¼š

```js
/* eslint-disable @typescript-eslint/no-require-imports */
```

é¿å…åœ¨æ™®é€šä¸šåŠ¡ä»£ç ä¸­åˆ°å¤„æ•£è½ `require`ï¼Œç»Ÿä¸€è§„èŒƒã€‚

### 4. æœªä½¿ç”¨çš„å˜é‡ä¸å¯¼å…¥

- ä¸¥æ ¼ç¦æ­¢ä¿ç•™æœªä½¿ç”¨çš„å˜é‡ã€å‚æ•°æˆ–å¯¼å…¥ï¼š
  - åŒ…æ‹¬ `@typescript-eslint/no-unused-vars` æç¤ºçš„ä»»ä½•å†…å®¹ã€‚
- ä¿®å¤ä¼˜å…ˆçº§ï¼š
  1. èƒ½åˆ é™¤çš„ç›´æ¥åˆ é™¤ï¼›
  2. å¦‚å› æ¥å£å…¼å®¹å¿…é¡»ä¿ç•™ï¼Œåˆ™åœ¨å¯¹åº”å‚æ•°å‰åŠ ä¸‹åˆ’çº¿ï¼ˆä¾‹å¦‚ `_unused`ï¼‰ä»¥æ¶ˆé™¤ lint æŠ¥é”™ï¼Œå¹¶åœ¨æ³¨é‡Šä¸­è¯´æ˜åŸå› ã€‚

æ›´æ–°åçš„æäº¤å‰æ£€æŸ¥æ¸…å•ï¼ˆåœ¨åŸæœ‰åŸºç¡€ä¸Šæ–°å¢ï¼‰ï¼š

- [ ] `npm run type-check` é€šè¿‡
- [ ] `npm run lint` é€šè¿‡ï¼ˆæ—  eslint errorï¼‰
- [ ] `npm run build` æˆåŠŸ
- [ ] æ²¡æœ‰ TypeScript ç±»å‹é”™è¯¯
- [ ] æ²¡æœ‰æœªä½¿ç”¨çš„å¯¼å…¥/å˜é‡
- [ ] æ²¡æœ‰æ–°çš„ `eslint-disable` è¢«éšæ„æ·»åŠ ï¼ˆå¦‚æœ‰ï¼Œå¿…é¡»æœ‰æ³¨é‡Šè¯´æ˜åŸå› ï¼‰
- [ ] **å·²æ›´æ–° Build ç‰ˆæœ¬**ï¼ˆè§ `.cursor/rules/build-version-rules.mdc`ï¼šæ¯æ¬¡æ›´æ–°é¡»åœ¨ `app/page.tsx` ä¸­é€’å¢ `Build: YYYY-MM-DD-NN`ï¼‰
- [ ] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ

## ğŸ“š ç›¸å…³èµ„æº

- TypeScript å®˜æ–¹æ–‡æ¡£: https://www.typescriptlang.org/docs/
- Next.js ç±»å‹æ£€æŸ¥: https://nextjs.org/docs/app/building-your-application/configuring/typescript
- é¡¹ç›® TypeScript é…ç½®: `tsconfig.json`

---

**è®°ä½**: å¦‚æœä»£ç ä¸èƒ½æ„å»ºæˆ–ä¸èƒ½é€šè¿‡ Lintï¼Œå°±ä¸èƒ½éƒ¨ç½²ã€‚  
å§‹ç»ˆç¡®ä¿ä»£ç å¯ä»¥é€šè¿‡ï¼š`npm run type-check`ã€`npm run lint`ã€`npm run build`ï¼
